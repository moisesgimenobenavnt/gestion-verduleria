<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sistema de Gesti√≥n SaaS</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        :root {
            --bg-body: #eceff1;
            --header: #212121;
            --rojo: #d50000;
            --verde: #00c853;
            --amarillo: #ffd600;
            --negro-borrado: #000;
        }
        body { font-family: 'Roboto', sans-serif; background: var(--bg-body); margin: 0; padding: 0; padding-bottom: 50px; }
        
        /* UTILIDADES */
        .oculto { display: none !important; }
        .texto-rojo { color: var(--rojo); font-weight: bold; }
        .full { width: 100%; box-sizing: border-box; }

        /* LOGIN UNIFICADO */
        #pantallaLogin {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999;
            background: #fff;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
        }
        .login-box { text-align: center; width: 80%; max-width: 300px; }
        .input-login {
            width: 100%; padding: 15px; margin: 10px 0; border: 2px solid #333; 
            border-radius: 5px; font-size: 18px; text-align: center; text-transform: uppercase;
        }
        .btn-entrar {
            width: 100%; padding: 15px; background: #000; color: #fff; 
            border: none; font-size: 18px; font-weight: bold; cursor: pointer;
        }

        /* ALERTA BACKUP (Solo Due√±o/Dev) */
        #modalBackup {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(200, 0, 0, 0.95); z-index: 10000;
            display: flex; justify-content: center; align-items: center; flex-direction: column; color: white;
            text-align: center; padding: 20px;
        }
        .btn-backup {
            background: white; color: red; font-size: 20px; padding: 20px; 
            border: none; font-weight: bold; margin-top: 20px; cursor: pointer; border-radius: 10px;
        }

        /* HEADER */
        #headerApp {
            background: var(--header); color: white; padding: 15px; 
            display: flex; justify-content: space-between; align-items: center;
        }
        .firma-soporte { font-size: 10px; opacity: 0.7; text-align: right; }

        /* ZONA TRABAJO */
        .contenedor { max-width: 600px; margin: 0 auto; padding: 10px; }

        /* CLIENTES & VENTA */
        .buscador { width: 100%; padding: 15px; font-size: 20px; border: 2px solid #000; box-sizing: border-box; text-transform: uppercase; }
        
        .sugerencias {
            background: white; border: 1px solid #ccc; max-height: 200px; overflow-y: auto;
        }
        .item-sug { padding: 15px; border-bottom: 1px solid #eee; font-size: 18px; }

        .ficha-cliente { background: white; padding: 15px; margin-top: 10px; border-radius: 8px; border-left: 5px solid #333; }
        .deuda-display { 
            background: var(--rojo); color: white; text-align: center; 
            padding: 10px; font-size: 24px; font-weight: bold; margin: 10px 0; border-radius: 5px;
        }
        .sin-deuda { background: var(--verde); }

        .input-monto {
            width: 100%; padding: 15px; font-size: 24px; text-align: center; font-weight: bold;
            border: 2px solid #aaa; margin-top: 10px; box-sizing: border-box; border-radius: 5px;
        }

        /* BOTONES PAGO */
        .grid-pagos { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; margin-top: 15px; }
        .btn-pago { padding: 15px; border: 1px solid #ccc; background: #fff; font-weight: bold; font-size: 12px; cursor: pointer; }
        .btn-pago.activo { background: #333; color: white; border-color: black; }

        /* SEM√ÅFORO PROVEEDOR */
        .panel-proveedor { margin-top: 10px; padding: 10px; border: 2px solid #ccc; text-align: center; border-radius: 5px; }
        .semaforo-box { 
            width: 100%; padding: 10px; color: white; font-weight: bold; margin-top: 5px; 
            border-radius: 5px; transition: 0.3s;
        }
        /* Colores din√°micos por JS */
        
        .animacion-flash { animation: flash 0.2s 6; }
        @keyframes flash { 0% {opacity: 1;} 50% {opacity: 0.2;} 100% {opacity: 1;} }

        /* LISTAS Y FILAS NEGRAS */
        .fila { padding: 10px; border-bottom: 1px solid #ddd; background: white; display: flex; justify-content: space-between; align-items: center; }
        
        .fila-negra { 
            background: var(--negro-borrado) !important; color: white !important; 
            text-decoration: line-through; border-bottom: 1px solid #444; 
        }
        .fila-negra span { color: white; }

        /* BOTONERA */
        .btn-guardar { width: 100%; padding: 20px; background: var(--verde); border: none; font-size: 20px; font-weight: bold; margin-top: 20px; cursor: pointer; }
        .btn-guardar:disabled { background: #ccc; cursor: not-allowed; }

        /* ACORDEONES */
        .acordeon { width: 100%; padding: 15px; text-align: left; background: #455a64; color: white; border: none; margin-top: 10px; font-weight: bold; cursor: pointer; }
        .panel { display: none; background: white; padding: 10px; border: 1px solid #ccc; }

    </style>
</head>
<body>

    <div id="pantallaLogin">
        <div class="login-box">
            <h2>ACCESO SISTEMA</h2>
            <input type="text" id="logUser" class="input-login" placeholder="USUARIO">
            <input type="password" id="logPass" class="input-login" placeholder="CLAVE">
            <button class="btn-entrar" onclick="login()">ENTRAR</button>
            <p id="errorLogin" style="color:red; display:none;">Datos Incorrectos</p>
        </div>
        <div style="margin-top:50px; font-size:10px; color:#aaa;">
            üíª Proveedor del Software: <strong>Mois√©s Gimeno</strong>
        </div>
    </div>

    <div id="modalBackup" class="oculto">
        <h1>‚ö†Ô∏è ALERTA DE SEGURIDAD</h1>
        <p>REGLA OBLIGATORIA DEL PROVEEDOR:</p>
        <p>Debe descargar la copia de seguridad encriptada ahora mismo.</p>
        <button class="btn-backup" onclick="descargarBackup()">üíæ DESCARGAR AL PENDRIVE</button>
    </div>

    <div id="app" class="oculto">
        
        <div id="headerApp">
            <div>
                <strong id="lblUsuario">...</strong>
            </div>
            <div class="firma-soporte">
                Soporte: Mois√©s Gimeno<br>
                +54 9 XX XXXX XXXX
            </div>
            <button onclick="location.reload()" style="background:red; color:white; border:none; margin-left:10px;">Salir</button>
        </div>

        <div class="contenedor">
            
            <input type="text" id="inputBuscar" class="buscador" placeholder="BUSCAR CLIENTE..." onkeyup="buscar(this.value)">
            <div id="sugerencias" class="sugerencias oculto"></div>

            <div id="ficha" class="ficha-cliente oculto">
                <h2 id="cliNombre" style="margin:0;">CLIENTE</h2>
                <div id="boxDeuda" class="deuda-display">$ 0</div>
                <button onclick="generarPDF()" style="background:#333; color:white; border:none; padding:5px; width:100%;">üñ®Ô∏è IMPRIMIR ESTADO DE CUENTA</button>

                <div style="margin-top:20px;">
                    <label>MONTO VENTA:</label>
                    <input type="tel" id="inputVenta" class="input-monto" placeholder="$ 0" onkeyup="formato(this); validar()">
                    
                    <label style="display:block; margin-top:10px;">PAGO:</label>
                    <input type="tel" id="inputPago" class="input-monto" placeholder="$ 0" onkeyup="formato(this); checkPago()">
                </div>

                <div id="zonaPagos" class="oculto">
                    <div class="grid-pagos">
                        <button class="btn-pago" onclick="setMetodo('EFECTIVO', this)">üíµ CAJA</button>
                        <button class="btn-pago" onclick="setMetodo('TARJETA', this)">üí≥ TARJETA</button>
                        <button class="btn-pago" onclick="setMetodo('TRANSFERENCIA', this)">üè¶ PROVEEDOR</button>
                    </div>

                    <div id="panelProv" class="panel-proveedor oculto">
                        <strong>DESTINO PAGO:</strong>
                        <select id="selProv" style="width:100%; padding:10px; margin-top:5px;" onchange="verSemaforo()">
                        </select>
                        <div id="semaforo" class="semaforo-box" style="background:#ccc;" 
                             onmousedown="verMontoHoy(true)" onmouseup="verMontoHoy(false)"
                             ontouchstart="verMontoHoy(true)" ontouchend="verMontoHoy(false)">
                            SELECCIONAR PROVEEDOR
                        </div>
                    </div>
                </div>

                <button id="btnGuardar" class="btn-guardar" onclick="guardar()" disabled>GUARDAR OPERACI√ìN</button>
            </div>

            <button class="acordeon" onmouseover="verHistorialCorto(true)" onmouseout="verHistorialCorto(false)">
                üí∞ CAJA Y MOVIMIENTOS
            </button>
            <div id="panelCaja" class="panel" style="display:block;">
                <button onclick="cargarCaja()" style="width:100%; padding:5px;">üîÑ Actualizar</button>
                
                <div id="radiografiaDueno" class="oculto" style="border: 2px solid red; padding:5px; margin:5px 0;">
                    <h3 style="margin:0; text-align:center;">RADIOGRAF√çA (SOLO DUE√ëO)</h3>
                    <div class="fila"><strong>VENTA TOTAL:</strong> <span id="lblVenta">$0</span></div>
                    <div class="fila"><strong>EFECTIVO:</strong> <span id="lblEfvo">$0</span></div>
                    <div class="fila"><strong>TARJETA:</strong> <span id="lblTarjeta">$0</span></div>
                    <div class="fila"><strong>PROVEEDORES:</strong> <span id="lblTransf">$0</span></div>
                    <div class="fila" style="color:red"><strong>GASTOS:</strong> <span id="lblGastos">$0</span></div>
                </div>

                <div id="listaMovimientos" style="font-size:12px; margin-top:10px;"></div>
                
                <div style="margin-top:20px; background:#eee; padding:10px; text-align:center;">
                    <h4>CIERRE DE TURNO</h4>
                    <input type="tel" class="input-monto" placeholder="EFECTIVO REAL EN CAJA" style="font-size:18px;">
                    <button style="background:black; color:white; border:none; padding:10px; margin-top:5px;">CERRAR CAJA</button>
                </div>
            </div>

            <div id="modulosDueno" class="oculto">
                <button class="acordeon">üë• GESTI√ìN CLIENTES (FULL)</button>
                <div class="panel">Aqu√≠ lista completa...</div>

                <button class="acordeon" onclick="cargarProvAdmin()">üè¶ GESTI√ìN PROVEEDORES</button>
                <div class="panel">
                    <input id="newProv" placeholder="NUEVO PROVEEDOR" class="input-login">
                    <button onclick="crearProv()">AGREGAR</button>
                    <div id="listaProvAdmin"></div>
                </div>
            </div>

        </div>
    </div>

<script>
    // --- VARIABLES GLOBALES ---
    let ROL = ''; // EMPLEADO, DUENO, DEV
    let USUARIO_NOMBRE = '';
    let CLIENTE_ACTUAL = null;
    let METODO = '';
    let LISTA_PROV = [];
    let DEUDA_PROV_SEL = 0; // Para sem√°foro

    // --- 1. LOGIN ---
    async function login() {
        const u = document.getElementById('logUser').value;
        const c = document.getElementById('logPass').value;
        
        try {
            const res = await fetch('/api/login', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ usuario: u, clave: c })
            });
            const data = await res.json();

            if (data.ok) {
                ROL = data.rol;
                USUARIO_NOMBRE = data.nombre;
                iniciarSistema();
            } else {
                document.getElementById('errorLogin').style.display = 'block';
            }
        } catch(e) { alert("Error conexi√≥n"); }
    }

    function iniciarSistema() {
        document.getElementById('pantallaLogin').style.display = 'none';
        
        // REGLA BACKUP OBLIGATORIO
        if (ROL === 'DUENO' || ROL === 'DEV') {
            document.getElementById('modalBackup').classList.remove('oculto');
        } else {
            document.getElementById('app').classList.remove('oculto');
        }
        
        document.getElementById('lblUsuario').innerText = USUARIO_NOMBRE;
        configurarPermisos();
        cargarCaja(); // Cargar datos iniciales
    }

    function descargarBackup() {
        window.open('/api/backup/download');
        // Esperamos un poco y dejamos entrar
        setTimeout(() => {
            document.getElementById('modalBackup').classList.add('oculto');
            document.getElementById('app').classList.remove('oculto');
        }, 2000);
    }

    function configurarPermisos() {
        if (ROL === 'DUENO' || ROL === 'DEV') {
            document.getElementById('radiografiaDueno').classList.remove('oculto');
            document.getElementById('modulosDueno').classList.remove('oculto');
        } else {
            // Empleado: Caja Ciega
            document.getElementById('radiografiaDueno').classList.add('oculto');
            document.getElementById('modulosDueno').classList.add('oculto');
        }
        cargarProveedores();
    }

    // --- 2. OPERATIVA VENTA ---
    async function buscar(q) {
        if(q.length < 1) return document.getElementById('sugerencias').classList.add('oculto');
        const res = await fetch(`/api/sugerencias/${q}`);
        const data = await res.json();
        const div = document.getElementById('sugerencias');
        div.innerHTML = `<div class="item-sug" style="color:blue" onclick="crearCli('${q}')">‚ûï NUEVO: ${q}</div>`;
        data.forEach(c => {
            div.innerHTML += `<div class="item-sug" onclick='selCli(${JSON.stringify(c)})'>${c.nombre}</div>`;
        });
        div.classList.remove('oculto');
    }

    async function crearCli(n) {
        const res = await fetch('/api/clientes/crear', {
            method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({nombre:n})
        });
        selCli(await res.json());
    }

    function selCli(c) {
        CLIENTE_ACTUAL = c;
        document.getElementById('sugerencias').classList.add('oculto');
        document.getElementById('inputBuscar').value = '';
        document.getElementById('ficha').classList.remove('oculto');
        document.getElementById('cliNombre').innerText = c.nombre;
        
        const box = document.getElementById('boxDeuda');
        box.innerText = "$ " + numberFormat(c.deuda);
        box.className = c.deuda > 0 ? 'deuda-display' : 'deuda-display sin-deuda';
        
        // Reset Inputs
        document.getElementById('inputVenta').value = '';
        document.getElementById('inputPago').value = '';
        document.getElementById('zonaPagos').classList.add('oculto');
    }

    function checkPago() {
        const p = clean(document.getElementById('inputPago').value);
        if(p > 0) document.getElementById('zonaPagos').classList.remove('oculto');
        else document.getElementById('zonaPagos').classList.add('oculto');
        validar();
    }

    function setMetodo(m, btn) {
        METODO = m;
        document.querySelectorAll('.btn-pago').forEach(b => b.classList.remove('activo'));
        btn.classList.add('activo');
        
        const pProv = document.getElementById('panelProv');
        if (m === 'TRANSFERENCIA') {
            pProv.classList.remove('oculto');
            pProv.classList.add('animacion-flash'); // FLASH VISUAL
        } else {
            pProv.classList.add('oculto');
        }
        validar();
    }

    async function cargarProveedores() {
        const res = await fetch('/api/receptores');
        LISTA_PROV = await res.json();
        const sel = document.getElementById('selProv');
        sel.innerHTML = '<option value="">-- ELEGIR --</option>';
        LISTA_PROV.forEach(p => {
            sel.innerHTML += `<option value="${p._id}">${p.nombre}</option>`;
        });
    }

    function verSemaforo() {
        const id = document.getElementById('selProv').value;
        const box = document.getElementById('semaforo');
        const p = LISTA_PROV.find(x => x._id === id);
        
        if (!p) {
            box.style.background = '#ccc';
            box.innerText = 'SELECCIONAR';
            return;
        }

        // L√≥gica Sem√°foro (Deuda vs Tope)
        // Verde: Le debemos poco. Rojo: Le debemos mucho (Cerca del tope)
        const ratio = p.saldoPorPagar / p.topeMaximo; 
        
        if (ratio > 0.9) { box.style.background = 'red'; box.innerText = 'üî¥ LLENO (DEUDA ALTA)'; }
        else if (ratio > 0.5) { box.style.background = '#ffd600'; box.style.color='black'; box.innerText = 'üü° DISPONIBLE'; }
        else { box.style.background = '#00c853'; box.innerText = 'üü¢ LIBRE'; }
        
        validar();
    }

    function verMontoHoy(activo) {
        // OJO ESP√çA
        const box = document.getElementById('semaforo');
        if (activo) {
            // Aqu√≠ deber√≠amos filtrar cu√°nto pagamos hoy a este prov. Simplificado:
            box.innerText = "üëÅÔ∏è PAGO HOY: (Consultando...)"; // Simulaci√≥n
        } else {
            verSemaforo(); // Restaurar texto normal
        }
    }

    function validar() {
        const v = clean(document.getElementById('inputVenta').value);
        const p = clean(document.getElementById('inputPago').value);
        const btn = document.getElementById('btnGuardar');
        
        let ok = false;
        if (p > 0 && METODO) {
             if (METODO === 'TRANSFERENCIA') {
                 if (document.getElementById('selProv').value) ok = true;
             } else {
                 ok = true;
             }
        } else if (v > 0 && p === 0) {
            ok = true; // Solo deuda
        }
        btn.disabled = !ok;
    }

    async function guardar() {
        const v = clean(document.getElementById('inputVenta').value);
        const p = clean(document.getElementById('inputPago').value);
        const pid = document.getElementById('selProv').value;

        const res = await fetch('/api/operaciones', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({
                clienteId: CLIENTE_ACTUAL._id,
                compra: v, pago: p, metodo: p > 0 ? METODO : 'CUENTA', receptorId: pid
            })
        });

        if(res.ok) {
            alert("‚úÖ GUARDADO");
            document.getElementById('ficha').classList.add('oculto');
            document.getElementById('inputBuscar').value = '';
            cargarCaja();
        }
    }

    // --- 3. CAJA Y BORRADO (FILA NEGRA) ---
    async function cargarCaja() {
        const res = await fetch('/api/caja-hoy');
        const data = await res.json();
        
        // Radiograf√≠a (Solo se ve si es ADMIN por CSS)
        const t = data.totales;
        document.getElementById('lblVenta').innerText = format(t.totalVenta);
        document.getElementById('lblEfvo').innerText = format(t.efectivo);
        document.getElementById('lblTarjeta').innerText = format(t.tarjeta);
        document.getElementById('lblTransf').innerText = format(t.transf);
        document.getElementById('lblGastos').innerText = format(t.gastos);

        // Lista Movimientos
        const div = document.getElementById('listaMovimientos');
        div.innerHTML = '';
        
        // Si es EMPLEADO, cortamos a 10. Si es ADMIN, todos.
        let movs = data.movimientos;
        if (ROL === 'EMPLEADO') movs = movs.slice(0, 10);

        movs.forEach(m => {
            let estilo = "fila";
            let btnBorrar = '';
            
            if (m.esBorrado) {
                estilo = "fila fila-negra"; // FILA NEGRA
            } else {
                // Bot√≥n borrar disponible para todos (Crea la mancha negra)
                btnBorrar = `<button onclick="borrarOp('${m._id}', '${m.metodo}')" style="background:red; color:white; border:none;">X</button>`;
            }

            div.innerHTML += `
                <div class="${estilo}">
                    <div>
                        ${m.esBorrado ? '‚¨õ ANULADO:' : ''} ${m.cliente} (${m.metodo})<br>
                        <b>$ ${format(m.pago || m.compra)}</b>
                        ${m.esBorrado ? `<br><small>Borrado por: ${m.usuarioBorrado}</small>` : ''}
                    </div>
                    ${btnBorrar}
                </div>
            `;
        });
    }

    async function borrarOp(id, metodo) {
        if (!confirm("¬øANULAR ESTA OPERACI√ìN? Quedar√° registrada la anulaci√≥n.")) return;

        // ALERTA ESPEC√çFICA DE TRANSFERENCIA
        if (metodo === 'TRANSFERENCIA') {
            alert("‚õî ATENCI√ìN: NO DEVOLVER EFECTIVO.\n\nEl dinero ya fue enviado al proveedor.\nContactar al Due√±o para que √©l devuelva el dinero al cliente por transferencia.");
        }

        await fetch('/api/operaciones/anular', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ idOperacion: id, usuario: USUARIO_NOMBRE })
        });
        cargarCaja();
    }

    // --- 4. PDF (jsPDF) ---
    function generarPDF() {
        const doc = new jspdf.jsPDF();
        const now = new Date();
        
        doc.setFontSize(18);
        doc.text("ESTADO DE CUENTA - VERDULER√çA", 20, 20);
        doc.setFontSize(12);
        doc.text(`Cliente: ${CLIENTE_ACTUAL.nombre}`, 20, 30);
        doc.text(`Fecha Impresi√≥n: ${now.toLocaleString()}`, 20, 40);
        doc.text(`Deuda Total: $ ${format(CLIENTE_ACTUAL.deuda)}`, 20, 50);
        
        doc.text("------------------------------------------------", 20, 60);
        doc.text("Detalle de movimientos disponible en sistema.", 20, 70);
        doc.text("Soporte Proveedor: Mois√©s Gimeno", 20, 280);
        
        doc.save(`Estado_${CLIENTE_ACTUAL.nombre}.pdf`);
    }

    // --- HELPERS ---
    function formato(i) {
        let v = i.value.replace(/\D/g,'');
        if(v!=='') i.value = new Intl.NumberFormat('es-AR').format(v);
    }
    function clean(v) { return parseInt(v.replace(/\./g,'')||0); }
    function format(v) { return new Intl.NumberFormat('es-AR').format(v); }

</script>
</body>
</html>
