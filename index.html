<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n Comercial Oriental</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f4f3; margin: 0; padding: 10px; color: #333; }
        .contenedor { width: 100%; max-width: 600px; margin: auto; background: white; padding: 25px; border-radius: 20px; box-shadow: 0 8px 30px rgba(0,0,0,0.1); box-sizing: border-box; }
        .reloje { text-align: center; font-size: 20px; font-weight: 900; color: #004d40; background: #e0f2f1; padding: 12px; border-radius: 12px; margin-bottom: 20px; }
        .deuda-box { font-size: 45px; color: #b71c1c; text-align: center; font-weight: bold; background: #ffebee; padding: 20px; border-radius: 15px; border: 3px solid #ffcdd2; margin: 15px 0; }
        input, select { width: 100%; padding: 18px; margin-top: 10px; border: 2px solid #ccc; border-radius: 12px; box-sizing: border-box; font-size: 18px; outline: none; transition: 0.3s; }
        input:focus { border-color: #2e7d32; }
        .btn { padding: 18px; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; font-size: 18px; width: 100%; margin-top: 15px; }
        .btn-verde { background: #2e7d32; color: white; }
        .btn-azul { background: #1565c0; color: white; }
        .btn-rojo { background: #c62828; color: white; }
        .btn-gris { background: #455a64; color: white; }
        .flex-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #eee; font-size: 16px; align-items: center; }
        .flash { animation: parpadeo 0.5s 3; }
        @keyframes parpadeo { 0% { background: white; } 50% { background: #ccff00; } 100% { background: white; } }
        .oculto { display: none; }
        .item-hist { border-bottom: 1px solid #ddd; padding: 15px 0; position: relative; }
        @media print { .no-print { display: none; } .contenedor { box-shadow: none; border: none; } }
    </style>
</head>
<body>

<div id="bloqueo" class="contenedor" style="margin-top: 15vh; text-align: center;">
    <h2>üîë Acceso Privado</h2>
    <input type="password" id="passAcceso" placeholder="Contrase√±a..." onkeydown="if(event.key==='Enter') validarAcceso()">
    <button class="btn btn-verde" onclick="validarAcceso()">ENTRAR AL SISTEMA</button>
</div>

<div id="contenidoWeb" class="oculto">
    <div class="contenedor no-print" id="uiBusqueda">
        <h1 style="text-align: center; color: #2e7d32;">Oriental Gesti√≥n</h1>
        <label>Buscar Cliente:</label>
        <input type="text" id="inputBusqueda" placeholder="Nombre o Tel√©fono..." onkeydown="if(event.key==='Enter') buscarOCrear()">
        <button class="btn btn-verde" onclick="buscarOCrear()">ABRIR FICHA</button>
    </div>

    <div id="ficha" class="contenedor oculto" style="margin-top:10px;">
        <div class="reloje" id="reloj"></div>
        <h2 id="nomDisp" style="text-align:center; margin:0; color:#1565c0; text-transform: uppercase;"></h2>
        <div class="deuda-box">$ <span id="montoDisp">0</span></div>

        <div id="formMover" class="no-print">
            <label>üõí Compra ($):</label>
            <input type="text" id="compra" placeholder="0" oninput="formatI(this)" onkeydown="if(event.key==='Enter') document.getElementById('pago').focus()">
            <label>üíµ Pago ($):</label>
            <input type="text" id="pago" placeholder="0" oninput="formatI(this)" onkeydown="if(event.key==='Enter') document.getElementById('metodo').focus()">
            
            <label>Forma de Pago:</label>
            <select id="metodo" onchange="seleccionarMetodo()">
                <option value="">-- ELIJA M√âTODO --</option>
                <option value="EFECTIVO">EFECTIVO</option>
                <option value="TRANSFERENCIA">TRANSFERENCIA</option>
                <option value="TARJETA">TARJETA</option>
            </select>

            <div id="divDestino" class="oculto">
                <label>üè¶ Enviar a:</label>
                <select id="selDestino"></select>
            </div>

            <button class="btn btn-verde" onclick="guardarOp()">üíæ GUARDAR OPERACI√ìN</button>
            <button class="btn btn-gris" onclick="verHistorial()">üìã HISTORIAL COMPLETO</button>
            <button class="btn btn-rojo" onclick="cerrarFicha()">‚ùå VOLVER</button>
        </div>

        <div id="seccionHist" class="oculto">
            <h3 style="text-align:center;">MOVIMIENTOS</h3>
            <div id="listaHist"></div>
            <button class="btn btn-gris no-print" onclick="window.print()">üñ®Ô∏è PDF</button>
            <button class="btn btn-rojo no-print" onclick="cerrarHist()">VOLVER</button>
        </div>
    </div>

    <div class="contenedor no-print" style="margin-top: 30px;">
        <button class="btn btn-gris" onclick="toggle('rep')">üìä REPORTES Y CAJA</button>
        <div id="rep" class="oculto" style="padding:15px; border:1px solid #ddd; border-radius:15px; margin-top:10px;">
            <label>Desde:</label> <input type="date" id="fD">
            <label>Hasta:</label> <input type="date" id="fH">
            <button class="btn btn-azul" onclick="cargarCaja()">MOSTRAR DATOS</button>
            <div id="cajaInfo"></div>
            <h4>üë• Deudores:</h4>
            <div id="listaD"></div>
            <h4>üè¶ Receptores:</h4>
            <div id="listaR"></div>
            <hr>
            <input type="text" id="rn" placeholder="Nombre Receptor">
            <input type="text" id="rm" placeholder="Monto" oninput="formatI(this)">
            <button class="btn btn-verde" onclick="addRec()">+ A√ëADIR MONTO</button>
        </div>
    </div>
</div>

<script>
    const CLAVE_M = "moises1";
    setInterval(() => { document.getElementById('reloj').innerText = new Date().toLocaleString(); }, 1000);

    function formatI(i) { let v = i.value.replace(/\D/g, ""); i.value = v ? new Intl.NumberFormat('de-DE').format(v) : ""; }
    function fM(v) { return new Intl.NumberFormat('de-DE').format(v); }
    function limpio(v) { return parseFloat(v.replace(/\./g, "")) || 0; }

    function validarAcceso() {
        if(document.getElementById('passAcceso').value === "2026") {
            document.getElementById('bloqueo').classList.add('oculto');
            document.getElementById('contenidoWeb').classList.remove('oculto');
            const hoy = new Date().toISOString().split('T')[0];
            document.getElementById('fD').value = hoy; document.getElementById('fH').value = hoy;
            cargarCaja();
        } else alert("Clave Incorrecta");
    }

    async function buscarOCrear() {
        const v = document.getElementById('inputBusqueda').value; if(!v) return;
        const res = await fetch(`/api/clientes/${v}`); const c = await res.json();
        abrirFicha(c);
    }

    function abrirFicha(c) {
        document.getElementById('nomDisp').innerText = c.nombre;
        document.getElementById('montoDisp').innerText = fM(c.deuda);
        document.getElementById('ficha').classList.remove('oculto');
        document.getElementById('uiBusqueda').classList.add('oculto');
        window.scrollTo(0,0);
    }

    function seleccionarMetodo() {
        const m = document.getElementById('metodo').value;
        const d = document.getElementById('divDestino');
        if(m === 'TRANSFERENCIA') {
            d.classList.remove('oculto');
            d.classList.add('flash'); setTimeout(() => d.classList.remove('flash'), 2000);
        } else d.classList.add('oculto');
    }

    async function cargarCaja() {
        const d = document.getElementById('fD').value;
        const h = document.getElementById('fH').value;
        const res = await fetch(`/api/reporte-caja?desde=${d}&hasta=${h}`);
        const data = await res.json();
        
        document.getElementById('cajaInfo').innerHTML = `
            <div class="flex-row"><span>Efectivo:</span> <b>$${fM(data.totales.EFECTIVO)}</b></div>
            <div class="flex-row"><span>Tarjeta:</span> <b>$${fM(data.totales.TARJETA)}</b></div>
            <div class="flex-row"><span>Transferencia:</span> <b>$${fM(data.totales.TRANSFERENCIA)}</b></div>
            <div class="flex-row" style="border-top:2px solid #000"><span>TOTAL DEUDAS:</span> <b style="color:red">$${fM(data.totalDeudaGeneral)}</b></div>
        `;

        document.getElementById('listaD').innerHTML = data.deudores.map(o => `
            <div class="flex-row" onclick="irACliente('${o.nombre}')"><span>${o.nombre}</span> <b style="color:red">$${fM(o.deuda)}</b></div>
        `).join('');

        document.getElementById('listaR').innerHTML = data.receptores.map(r => {
            let color = r.saldoRestante > 50000 ? "green" : (r.saldoRestante > 0 ? "orange" : "#00ff00");
            let texto = r.saldoRestante <= 0 ? "SUPER√ÅVIT" : "FALTA";
            return `<div class="flex-row">
                <span style="color:blue; cursor:pointer;" onclick="histRec('${r.nombre}')">${r.nombre} (FIJO: $${fM(r.montoObjetivo)})</span>
                <b style="color:${color}">${texto}: $${fM(Math.abs(r.saldoRestante))}</b>
            </div>`;
        }).join('');

        document.getElementById('selDestino').innerHTML = data.receptores.map(r => `<option value="${r.nombre}">${r.nombre}</option>`).join('');
    }

    async function irACliente(n) { const res = await fetch(`/api/clientes/${n}`); const c = await res.json(); abrirFicha(c); }

    async function guardarOp() {
        if(!document.getElementById('metodo').value) { alert("¬°Debe elegir la Forma de Pago!"); return; }
        const body = {
            cliente: document.getElementById('nomDisp').innerText,
            compra: limpio(document.getElementById('compra').value),
            pago: limpio(document.getElementById('pago').value),
            metodo: document.getElementById('metodo').value,
            destino: document.getElementById('selDestino').value
        };
        await fetch('/api/operaciones', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body) });
        alert("Guardado"); cerrarFicha(); cargarCaja();
    }

    async function verHistorial() {
        const res = await fetch(`/api/historial/${document.getElementById('nomDisp').innerText}`);
        const data = await res.json();
        document.getElementById('listaHist').innerHTML = data.map(h => `
            <div class="item-hist">
                <b>${new Date(h.fecha).toLocaleString()}</b><br>
                Compra: $${fM(h.compra)} | Pago: $${fM(h.pago)} (${h.metodo} ${h.destino||''})<br>
                Saldo: <b style="color:red">$${fM(h.deudaCorte)}</b>
                <button onclick="borrarOp('${h._id}')" style="position:absolute; right:0; top:15px; background:none; border:none; cursor:pointer;">üóëÔ∏è</button>
            </div>
        `).join('');
        document.getElementById('formMover').classList.add('oculto');
        document.getElementById('seccionHist').classList.remove('oculto');
    }

    async function histRec(nom) {
        const res = await fetch(`/api/historial-receptor/${nom}`);
        const data = await res.json();
        document.getElementById('nomDisp').innerText = "REC: " + nom;
        document.getElementById('listaHist').innerHTML = data.map(h => `
            <div class="item-hist">
                <b>${new Date(h.fecha).toLocaleString()}</b><br>
                Cliente: ${h.cliente} | Pago: $${fM(h.pago)}
            </div>
        `).join('');
        document.getElementById('ficha').classList.remove('oculto');
        document.getElementById('uiBusqueda').classList.add('oculto');
        document.getElementById('formMover').classList.add('oculto');
        document.getElementById('seccionHist').classList.remove('oculto');
    }

    async function borrarOp(id) {
        if(prompt("Introduzca Contrase√±a Maestra:") === CLAVE_M) {
            await fetch(`/api/operaciones/${id}`, { method: 'DELETE' });
            alert("Eliminado"); verHistorial(); cargarCaja();
        } else alert("Contrase√±a incorrecta");
    }

    function cerrarFicha() {
        document.getElementById('ficha').classList.add('oculto');
        document.getElementById('uiBusqueda').classList.remove('oculto');
        document.getElementById('compra').value = ""; document.getElementById('pago').value = "";
    }
    function cerrarHist() { document.getElementById('seccionHist').classList.add('oculto'); document.getElementById('formMover').classList.remove('oculto'); }
    function toggle(id) { document.getElementById(id).classList.toggle('oculto'); }
    async function addRec() {
        await fetch('/api/receptores', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ nombre: document.getElementById('rn').value, monto: limpio(document.getElementById('rm').value) }) });
        cargarCaja();
    }
</script>
</body>
</html>
