<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SISTEMA VISI√ìN MOIS√âS V5 - MASTER CLOUD</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&family=Roboto:wght@400;900&display=swap" rel="stylesheet">

    <style>
        /* =====================================================================
           1. VARIABLES GLOBALES DE DISE√ëO (LA PALETA DE COLORES)
           ===================================================================== */
        :root {
            --rojo-fosfo: #ff0000;       /* Para deudas y alertas cr√≠ticas */
            --verde-ok: #00c853;         /* Para dinero entrante y √©xito */
            --amarillo: #ffd600;         /* Para advertencias de seguridad */
            --fondo-negro: #000000;      /* Para contrastes altos (Usuario 2) */
            --gris-panel: #263238;       /* Para los paneles del s√≥tano */
            --azul-moises: #1a237e;      /* Para la auditor√≠a forense */
            --blanco: #ffffff;           /* Fondo general */
            --naranja-pago: #ff6d00;     /* Para botones de pago a proveedores */
        }

        /* =====================================================================
           2. CONFIGURACI√ìN BASE DEL CUERPO (BODY)
           ===================================================================== */
        body { 
            font-family: 'Roboto', sans-serif; 
            margin: 0; 
            background: #eceff1; 
            overflow-y: auto; /* Permitir scroll vertical siempre */
            min-height: 100vh;
            padding-bottom: 150px; /* Espacio extra al final para scroll c√≥modo */
        }

        /* Clase utilitaria para ocultar elementos */
        .oculto { 
            display: none !important; 
        }

        /* =====================================================================
           3. CABECERA FIJA (HEADER) - MARCA DEL PROPIETARIO
           ===================================================================== */
        .header-moises {
            background: var(--blanco);
            border-bottom: 6px solid var(--fondo-negro);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky; /* Se queda pegado arriba al bajar */
            top: 0;
            z-index: 5000; /* Siempre encima de todo */
            box-shadow: 0 5px 20px rgba(0,0,0,0.4);
        }

        .marca-propiedad {
            display: flex;
            flex-direction: column;
        }

        .texto-legal {
            font-size: 12px; 
            color: #333; 
            text-transform: uppercase; 
            letter-spacing: 1px;
            margin-bottom: 5px;
        }

        .titulo-negocio {
            font-weight: 900; 
            font-size: 28px; 
            letter-spacing: -1px;
            text-transform: uppercase;
        }

        .reloj-digital {
            font-family: 'Roboto Mono', monospace;
            color: var(--rojo-fosfo);
            font-size: 38px;
            font-weight: 900;
            text-shadow: 2px 2px 4px #ccc;
            background: #fff;
            padding: 5px 15px;
            border-radius: 10px;
            border: 2px solid #eee;
        }

        /* =====================================================================
           4. CONTENEDORES Y FORMULARIOS (INPUTS)
           ===================================================================== */
        .contenedor-principal {
            padding: 30px;
            max-width: 1000px;
            margin: auto;
        }
        
        /* Estilo de las cajas de texto (Gigantes y claras) */
        .input-moises {
            width: 100%;
            padding: 25px;
            font-size: 26px;
            border: 5px solid var(--fondo-negro);
            border-radius: 15px;
            box-sizing: border-box;
            text-transform: uppercase;
            font-weight: 900;
            margin-bottom: 25px;
            background: #fff;
            transition: all 0.2s;
            color: #000;
        }

        .input-moises:focus {
            border-color: var(--azul-moises);
            outline: none;
            box-shadow: 0 0 20px rgba(26, 35, 126, 0.4);
            transform: scale(1.01);
        }

        .input-moises::placeholder {
            color: #999;
            font-weight: normal;
        }

        /* =====================================================================
           5. BOTONES DE ACCI√ìN (ESTILO INDESTRUCTIBLE)
           ===================================================================== */
        .btn-guardar-total {
            width: 100%;
            padding: 35px;
            background: var(--verde-ok);
            color: white;
            font-size: 28px;
            font-weight: 900;
            border: 5px solid #000;
            border-radius: 20px;
            cursor: pointer;
            box-shadow: 0 15px 0 #00692c; /* Efecto 3D */
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: transform 0.1s, box-shadow 0.1s;
        }
        
        .btn-guardar-total:active {
            transform: translateY(8px); /* Efecto de hundimiento al presionar */
            box-shadow: 0 7px 0 #00692c;
        }

        .btn-guardar-total:disabled {
            background: #cfd8dc;
            color: #90a4ae;
            box-shadow: none;
            cursor: not-allowed;
            border-color: #b0bec5;
        }

        /* Variaciones de botones */
        .btn-rojo { 
            background: var(--rojo-fosfo); 
            box-shadow: 0 15px 0 #b71c1c; 
        }
        .btn-rojo:active { 
            box-shadow: 0 7px 0 #b71c1c; 
        }

        .btn-naranja { 
            background: var(--naranja-pago); 
            box-shadow: 0 15px 0 #e65100; 
            border-color: #e65100; 
        }
        .btn-naranja:active { 
            box-shadow: 0 7px 0 #e65100; 
        }

        /* =====================================================================
           6. TARJETAS DE INFORMACI√ìN (CLIENTE Y DEUDA)
           ===================================================================== */
        .nombre-cliente-xl {
            font-size: 60px;
            font-weight: 900;
            text-align: center;
            display: block;
            margin: 30px 0 20px 0;
            text-transform: uppercase;
            color: #212121;
            line-height: 1;
            border-bottom: 4px solid #000;
            padding-bottom: 20px;
        }

        .deuda-historica-card {
            background: var(--rojo-fosfo);
            color: white;
            padding: 40px;
            border-radius: 25px;
            text-align: center;
            margin-bottom: 40px;
            box-shadow: 0 20px 40px rgba(255,0,0,0.3);
            border: 6px solid #000;
            position: relative;
        }

        .deuda-historica-card h2 {
            margin: 0;
            font-size: 24px;
            letter-spacing: 3px;
            text-transform: uppercase;
            opacity: 0.9;
        }

        .deuda-historica-card .monto {
            font-size: 90px;
            font-weight: 900;
            display: block;
            margin-top: 15px;
            text-shadow: 4px 4px 0px #000;
        }

        /* =====================================================================
           7. EL S√ìTANO (ACORDEONES DESPLEGABLES)
           ===================================================================== */
        .sotano-container {
            margin-top: 80px;
            border-top: 10px solid #000;
            background: var(--gris-panel);
            padding-bottom: 50px;
        }

        .btn-acordeon {
            width: 100%;
            padding: 35px;
            background: var(--gris-panel);
            color: white;
            font-size: 24px;
            font-weight: 900;
            text-align: left;
            border: none;
            border-bottom: 2px solid #455a64;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background 0.3s;
        }

        .btn-acordeon:hover {
            background: #37474f;
        }

        .btn-acordeon span:last-child {
            background: #000;
            padding: 5px 15px;
            border-radius: 50%;
        }

        .panel-sotano {
            background: #fff;
            display: none;
            padding: 40px;
            border: 6px solid var(--gris-panel);
            border-top: none;
        }

        /* =====================================================================
           8. TABLAS Y AUDITOR√çA FORENSE
           ===================================================================== */
        table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 25px; 
        }
        
        th { 
            background: #cfd8dc; 
            padding: 20px; 
            text-align: left; 
            border: 3px solid #000; 
            font-weight: 900; 
            font-size: 16px;
            text-transform: uppercase;
        }
        
        td { 
            padding: 20px; 
            border: 1px solid #ddd; 
            font-size: 18px; 
            font-weight: bold;
        }

        .forense-tag {
            font-family: 'Roboto Mono', monospace;
            font-size: 14px;
            color: #d32f2f;
            font-weight: bold;
            display: block;
            margin-bottom: 8px;
            background: #ffebee;
            padding: 5px;
            border-left: 4px solid #d32f2f;
        }

        .alerta-caja-full {
            background: var(--azul-moises);
            color: white;
            padding: 30px;
            text-align: center;
            font-size: 26px;
            font-weight: 900;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 5px solid #000;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        }

        /* Estilos espec√≠ficos para impresi√≥n en PDF o papel */
        @media print {
            .btn-guardar-total, 
            .sotano-container, 
            #pantallaLogin { 
                display: none; 
            }
            body { background: white; }
            .deuda-historica-card { 
                color: black; 
                background: white; 
                border: 2px solid black; 
            }
        }
    </style>
</head>
<body>

    <div id="pantallaLogin" style="position:fixed; inset:0; background:#fff; z-index:9999; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:20px;">
        
        <h1 style="font-size:70px; margin-bottom:10px; text-align:center; font-weight:900; letter-spacing:-3px;">VISI√ìN MOIS√âS V5</h1>
        <div style="background:black; color:white; padding:5px 20px; margin-bottom:50px; font-weight:bold; letter-spacing:2px;">SOFTWARE DE GESTI√ìN PRIVADO</div>
        
        <div style="width:100%; max-width:500px; background:#eee; padding:40px; border-radius:20px; border:4px solid #000;">
            
            <label style="font-weight:bold; display:block; margin-bottom:5px;">USUARIO:</label>
            <input type="text" id="userIn" class="input-moises" placeholder="ESCRIBA SU USUARIO" autocomplete="off" style="font-size:20px;">
            
            <label style="font-weight:bold; display:block; margin-bottom:5px;">CLAVE DE ACCESO:</label>
            <input type="password" id="passIn" class="input-moises" placeholder="‚óè‚óè‚óè‚óè‚óè‚óè‚óè‚óè" autocomplete="new-password" style="font-size:20px;">
            
            <button onclick="intentarLogin()" class="btn-guardar-total" style="font-size:24px; padding:25px;">ENTRAR AL SISTEMA</button>
            
            <p id="msgLogin" style="text-align:center; color:red; font-weight:bold; margin-top:20px; font-size:18px;" class="oculto">
                ‚õî CREDENCIALES INCORRECTAS
            </p>
        </div>
        <p style="margin-top:50px; color:#999; font-size:12px;">Protegido por Sistema de Huella Forense.</p>
    </div>

    <div id="modalBackup" class="oculto" style="position:fixed; inset:0; background:rgba(213,0,0,0.98); z-index:10000; color:white; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center; padding:30px;">
        <div style="border:5px solid white; padding:50px; border-radius:30px; max-width:700px;">
            <h1 style="font-size:60px; font-weight:900; margin-bottom:10px; color:var(--amarillo);">‚ö†Ô∏è ATENCI√ìN</h1>
            <h2 style="font-size:30px; margin-bottom:30px;">PROTOCOLO DE SEGURIDAD OBLIGATORIO</h2>
            <p style="font-size:24px; line-height:1.5; margin-bottom:40px;">
                Para garantizar la integridad de los datos, el DUE√ëO debe realizar una 
                <strong>COPIA DE SEGURIDAD ENCRIPTADA</strong> antes de operar.
            </p>
            <button onclick="ejecutarBackupYEntrar()" class="btn-guardar-total" style="background:white; color:red; border-color:white; box-shadow:0 10px 0 #ccc;">
                ‚¨áÔ∏è DESCARGAR COPIA Y ENTRAR
            </button>
        </div>
    </div>

    <div id="app" class="oculto">
        
        <header class="header-moises">
            <div class="marca-propiedad">
                <span class="texto-legal">Software en Alquiler - Propiedad de Mois√©s - [Tel√©fono]</span>
                <span class="titulo-negocio">FRUTAS Y VERDURAS "EL CONTROL"</span>
            </div>
            <div id="reloj" class="reloj-digital">00:00:00</div>
        </header>

        <div class="contenedor-principal">
            
            <div style="position:relative;">
                <input type="text" id="buscador" class="input-moises" placeholder="üîç BUSCAR CLIENTE POR NOMBRE O TEL√âFONO..." onkeyup="buscarClienteDB(this.value)">
                
                <div id="sugerencias" class="oculto" style="background:white; border:4px solid #000; max-height:400px; overflow-y:auto; position:absolute; width:100%; top:90px; z-index:100; box-shadow:0 15px 30px rgba(0,0,0,0.5); border-radius:0 0 15px 15px;"></div>
            </div>

            <div id="fichaVenta" class="oculto">
                <span id="cliNombre" class="nombre-cliente-xl">---</span>
                
                <div id="boxDeuda" class="deuda-historica-card">
                    <h2>DEUDA ACTUAL REGISTRADA EN NUBE</h2>
                    <span id="montoDeuda" class="monto">$ 0</span>
                    <small style="color:white; opacity:0.8;">Sincronizado con MongoDB Atlas</small>
                </div>

                <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom:20px;">
                    <div>
                        <span style="font-weight:900; font-size:20px; display:block; margin-bottom:10px;">TOTAL VENTA ($)</span>
                        <input type="tel" id="inTotalVenta" class="input-moises" placeholder="$ 0" onkeyup="validarVenta()">
                    </div>
                    <div>
                        <span style="font-weight:900; font-size:20px; display:block; margin-bottom:10px;">CLIENTE ABONA ($)</span>
                        <input type="tel" id="inAbona" class="input-moises" placeholder="$ 0" onkeyup="verificarPago()">
                    </div>
                </div>

                <div id="boxReceptor" class="oculto" style="margin-bottom:30px; border:4px solid #000; padding:25px; border-radius:20px; text-align:center; background:#fff8e1; box-shadow:0 5px 15px rgba(0,0,0,0.1);">
                    <span style="font-weight:900; font-size:24px; display:block; margin-bottom:15px; color:#e65100;">DESTINO DE LOS FONDOS</span>
                    <select id="selDestinoDinero" class="input-moises" style="margin-bottom:0; cursor:pointer;">
                        <option value="CAJA">üì• CAJA EFECTIVO (MOSTRADOR)</option>
                        <option value="MP">üì± MERCADO PAGO</option>
                        <option value="BCO">üè¶ CUENTA BANCARIA</option>
                    </select>
                </div>

                <button id="btnGuardarOperacion" class="btn-guardar-total" disabled onclick="guardarVentaDB()">CONFIRMAR OPERACI√ìN</button>
            </div>
        </div>

        <div class="sotano-container">
            
            <button class="btn-acordeon" onclick="cargarCajaDB(); toggle('panelCaja')">
                <span>üí∞ CAJA Y MOVIMIENTOS (DB)</span>
                <span>‚ñº</span>
            </button>
            <div id="panelCaja" class="panel-sotano">
                
                <div id="cajaU1" class="oculto">
                    <div style="background:#f9f9f9; padding:30px; border:4px solid #000; margin-bottom:40px; border-radius:20px;">
                        <h3 style="margin-top:0; font-size:30px; border-bottom:2px solid #ccc; padding-bottom:10px;">REGISTRO DE RETIRO DE EFECTIVO</h3>
                        <p style="margin-bottom:25px; color:#555; font-size:18px;">Ingrese qui√©n retira el dinero f√≠sico de la caja para su resguardo.</p>
                        
                        <input type="text" id="respRetiro" class="input-moises" style="font-size:22px; padding:20px;" placeholder="NOMBRE DEL RESPONSABLE">
                        <input type="tel" id="montRetiro" class="input-moises" placeholder="MONTO A RETIRAR $">
                        
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                            <button onclick="guardarRetiroDB('RETIRO PARCIAL')" class="btn-guardar-total" style="background:#455a64; border-color:#263238; font-size:20px;">
                                üì• GUARDADO PARCIAL
                            </button>
                            <button onclick="guardarRetiroDB('CIERRE FINAL')" class="btn-guardar-total" style="background:#000; border-color:#212121; font-size:20px; color:white;">
                                üîí CIERRE FINAL TURNO
                            </button>
                        </div>
                    </div>
                </div>

                <div id="cajaU2" class="oculto">
                    <div id="alertaAuditCaja" class="alerta-caja-full">CONECTANDO CON SERVIDOR...</div>
                </div>

                <h4 style="border-bottom:4px solid #000; padding-bottom:15px; font-size:22px;">HISTORIAL DE MOVIMIENTOS (HUELLA FORENSE)</h4>
                <div id="listaMovimientosDB">Cargando datos desde el servidor...</div>
            </div>

            <button class="btn-acordeon" onclick="toggle('panelGastos')">
                <span>üí∏ GASTOS VARIOS</span>
                <span>‚ñº</span>
            </button>
            <div id="panelGastos" class="panel-sotano">
                <div style="background:#ffebee; padding:15px; border-left:5px solid red; margin-bottom:20px;">
                    <strong>NOTA:</strong> Todo gasto registrado descuenta autom√°ticamente del total de caja f√≠sica.
                </div>
                <input type="text" id="gasDetalle" class="input-moises" placeholder="CONCEPTO DEL GASTO (EJ: BOLSAS, LIMPIEZA)">
                <input type="tel" id="gasMonto" class="input-moises" placeholder="$ MONTO GASTADO">
                <button onclick="guardarGastoDB()" class="btn-guardar-total btn-rojo">REGISTRAR GASTO EN DB</button>
            </div>

            <button class="btn-acordeon" onclick="cargarDeudoresDB(); toggle('panelDeudores')">
                <span>üìâ MAYORES DEUDORES (Ranking)</span>
                <span>‚ñº</span>
            </button>
            <div id="panelDeudores" class="panel-sotano">
                <div style="display:flex; gap:20px; margin-bottom:30px;">
                    <button onclick="cargarDeudoresDB('monto')" style="flex:1; padding:20px; background:#333; color:white; font-weight:bold; border:none; cursor:pointer;">ORDENAR POR MONTO ($)</button>
                    <button onclick="cargarDeudoresDB('nombre')" style="flex:1; padding:20px; background:#333; color:white; font-weight:bold; border:none; cursor:pointer;">ORDENAR POR NOMBRE (A-Z)</button>
                </div>
                <div id="listaDeudoresDB">Cargando datos del servidor...</div>
            </div>

            <button class="btn-acordeon" onclick="cargarProveedoresDB(); toggle('panelProv')">
                <span>üè¶ PROVEEDORES Y PAGOS (FIFO)</span>
                <span>‚ñº</span>
            </button>
            <div id="panelProv" class="panel-sotano">
                <div id="contProveedoresDB" style="margin-bottom:30px;"></div>
                
                <div style="background:#fff3e0; padding:30px; border:5px solid #ff9800; border-radius:20px;">
                    <h3 style="margin-top:0; color:#e65100; font-size:28px;">PAGO MANUAL "EL GUTI√âRREZ"</h3>
                    <p style="font-size:16px; margin-bottom:20px;">Salida de dinero manual hacia proveedor. El sistema descontar√° de la deuda m√°s antigua (FIFO).</p>
                    
                    <select id="selProvDB" class="input-moises" style="font-size:20px; margin-bottom:20px; cursor:pointer;"></select>
                    <input type="tel" id="montProv" class="input-moises" placeholder="$ MONTO A PAGAR">
                    <button onclick="pagoManualProvDB()" class="btn-guardar-total btn-naranja">REGISTRAR PAGO PROVEEDOR</button>
                </div>
            </div>

            <button class="btn-acordeon" onclick="toggle('panelEst')">
                <span>‚öñÔ∏è ESTAD√çSTICAS (Ganancia Neta)</span>
                <span>‚ñº</span>
            </button>
            <div id="panelEst" class="panel-sotano">
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom:30px;">
                    <div>
                        <label style="font-weight:bold; display:block; margin-bottom:5px;">FECHA DESDE:</label>
                        <input type="date" id="estDesde" class="input-moises" style="font-size:20px; padding:15px;">
                    </div>
                    <div>
                        <label style="font-weight:bold; display:block; margin-bottom:5px;">FECHA HASTA:</label>
                        <input type="date" id="estHasta" class="input-moises" style="font-size:20px; padding:15px;">
                    </div>
                </div>
                <button onclick="calcularVeredictoDB()" class="btn-guardar-total" style="background:#000; border-color:#333; color:white;">CONSULTAR VEREDICTO FINANCIERO</button>
                <div id="resultEstDB" style="margin-top:40px; text-align:center;"></div>
            </div>

        </div>
    </div>

    <script>
        // --- 1. CONFIGURACI√ìN VITAL PARA LA NUBE ---
        // Al dejar '/api', el navegador entiende que debe buscar en el MISMO servidor
        // donde est√° alojada la p√°gina. Esto arregla el error de "puerto 10000 vs 3001".
        const API_URL = '/api'; 
        
        let USUARIO_ACTUAL = { rol: 0, nombre: '' };

        // RELOJ INICIADO
        setInterval(() => {
            const ahora = new Date();
            document.getElementById('reloj').innerText = ahora.toLocaleTimeString();
        }, 1000);

        // ------------------------------------------------------------------
        // 2. SISTEMA DE LOGIN Y PERMISOS
        // ------------------------------------------------------------------
        function intentarLogin() {
            const u = document.getElementById('userIn').value.toUpperCase().trim();
            const c = document.getElementById('passIn').value;
            const msg = document.getElementById('msgLogin');

            // Autenticaci√≥n Frontend (Datos viajan seguros en backend real)
            if(u === 'LOCAL' && c === '1234') setSession(1, 'VENDEDOR');
            else if(u === 'ADMIN' && c === 'DUENO2026') setSession(2, 'ADMINISTRADOR');
            else if(u === 'MOISES' && c === 'MASTERKEY') setSession(3, 'SOPORTE T√âCNICO');
            else {
                msg.classList.remove('oculto');
                setTimeout(() => msg.classList.add('oculto'), 3000);
            }
        }

        function setSession(rol, nombre) {
            USUARIO_ACTUAL = { rol, nombre };
            document.getElementById('pantallaLogin').classList.add('oculto');
            
            // LIMPIEZA DE SEGURIDAD PARA MODO FANTASMA
            document.getElementById('userIn').value = '';
            document.getElementById('passIn').value = '';
            
            // Si es Due√±o, forzamos Backup
            if(rol === 2) document.getElementById('modalBackup').classList.remove('oculto');
            else iniciarInterfaz();
        }

        function ejecutarBackupYEntrar() {
            // Simulacro de descarga segura
            alert("‚úÖ BACKUP ENCRIPTADO DESCARGADO CORRECTAMENTE.");
            document.getElementById('modalBackup').classList.add('oculto');
            iniciarInterfaz();
        }

        function iniciarInterfaz() {
            document.getElementById('app').classList.remove('oculto');
            // Configurar vistas seg√∫n rol (Ceguera vs Visi√≥n Total)
            if(USUARIO_ACTUAL.rol === 1) {
                document.getElementById('cajaU1').classList.remove('oculto');
            }
            if(USUARIO_ACTUAL.rol >= 2) {
                document.getElementById('cajaU2').classList.remove('oculto');
            }
        }

        // ------------------------------------------------------------------
        // 3. BUSCADOR INTELIGENTE (CONECTADO A DB)
        // ------------------------------------------------------------------
        async function buscarClienteDB(query) {
            const sug = document.getElementById('sugerencias');
            if(query.length < 2) return sug.classList.add('oculto');

            try {
                // Petici√≥n al servidor (Hongo)
                const res = await fetch(`${API_URL}/clientes/${query}`);
                
                // Validaci√≥n de conexi√≥n
                if(!res.ok) throw new Error("Error server");

                const clientes = await res.json();
                sug.innerHTML = '';

                // Opci√≥n Crear Nuevo
                sug.innerHTML += `
                    <div style="padding:25px; color:blue; font-weight:900; cursor:pointer; border-bottom:2px solid #eee; background:#f5faff;" 
                         onclick="prepararCliente('${query}', 0)">
                        ‚ûï CREAR NUEVO CLIENTE: "${query}"
                    </div>`;
                
                // Listar resultados encontrados
                clientes.forEach(c => {
                    sug.innerHTML += `
                        <div style="padding:25px; border-bottom:1px solid #eee; cursor:pointer; font-size:18px; transition:background 0.2s;" 
                             onclick="prepararCliente('${c.nombre}', ${c.deudaActual})"
                             onmouseover="this.style.background='#f9f9f9'" onmouseout="this.style.background='white'">
                             üë§ <b>${c.nombre}</b> 
                             <span style="float:right; color:red; font-weight:900; font-size:20px;">
                                 $ ${c.deudaActual.toLocaleString()}
                             </span>
                        </div>`;
                });
                sug.classList.remove('oculto');

            } catch (e) {
                console.error("No se pudo conectar a DB:", e);
                // Si falla, mostramos fallback discreto
                sug.classList.add('oculto');
            }
        }

        function prepararCliente(nombre, deuda) {
            document.getElementById('sugerencias').classList.add('oculto');
            document.getElementById('fichaVenta').classList.remove('oculto');
            
            // Llenar datos visuales
            document.getElementById('cliNombre').innerText = nombre;
            document.getElementById('montoDeuda').innerText = `$ ${deuda.toLocaleString()}`;
            document.getElementById('buscador').value = ''; // Limpiar buscador
            
            // Foco en input venta para agilidad
            document.getElementById('inTotalVenta').focus();
        }

        // ------------------------------------------------------------------
        // 4. L√ìGICA DE VENTA Y PAGOS (SPLIT)
        // ------------------------------------------------------------------
        function verificarPago() {
            const abona = parseInt(document.getElementById('inAbona').value) || 0;
            if(abona > 0) document.getElementById('boxReceptor').classList.remove('oculto');
            else document.getElementById('boxReceptor').classList.add('oculto');
            validarVenta();
        }

        function validarVenta() {
            const total = parseInt(document.getElementById('inTotalVenta').value) || 0;
            document.getElementById('btnGuardarOperacion').disabled = total <= 0;
        }

        async function guardarVentaDB() {
            // Recolecci√≥n de datos
            const nombre = document.getElementById('cliNombre').innerText;
            const venta = parseInt(document.getElementById('inTotalVenta').value);
            const pago = parseInt(document.getElementById('inAbona').value) || 0;
            const destino = document.getElementById('selDestinoDinero').value;
            
            const deudaGenerada = venta - pago;

            // Objeto de Seguridad (Payload)
            const payload = {
                tipo: "VENTA",
                monto: venta,
                pagoReal: pago,
                cliente: nombre,
                destinoFondos: destino,
                usuarioRegistra: USUARIO_ACTUAL.nombre,
                responsableFisico: USUARIO_ACTUAL.nombre, 
                fecha: new Date().toLocaleDateString(),
                hora: new Date().toLocaleTimeString()
            };

            try {
                // 1. Enviar Movimiento al Servidor
                const resMov = await fetch(`${API_URL}/movimientos`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });

                if(!resMov.ok) throw new Error("Fallo guardado movimiento");

                // 2. Actualizar Cliente en Servidor (Deuda)
                if(deudaGenerada !== 0 || pago > 0) {
                    await fetch(`${API_URL}/clientes`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ nombre: nombre, deuda: deudaGenerada })
                    });
                }

                alert("‚úÖ OPERACI√ìN EXITOSA: GUARDADA EN NUBE.");
                
                // Reset UI
                document.getElementById('fichaVenta').classList.add('oculto');
                document.getElementById('inTotalVenta').value = '';
                document.getElementById('inAbona').value = '';

            } catch(e) {
                alert("‚ùå ERROR CR√çTICO: El servidor no responde.");
            }
        }

        // ------------------------------------------------------------------
        // 5. CAJA CIEGA Y RETIROS (U1 vs U2)
        // ------------------------------------------------------------------
        async function guardarRetiroDB(tipo) {
            const resp = document.getElementById('respRetiro').value.toUpperCase();
            const mont = parseInt(document.getElementById('montRetiro').value) || 0;

            if(!resp || mont <= 0) return alert("‚ö†Ô∏è DEBE INGRESAR NOMBRE Y MONTO V√ÅLIDO");

            const payload = {
                tipo: tipo, // 'RETIRO PARCIAL' o 'CIERRE FINAL'
                monto: mont,
                usuarioRegistra: USUARIO_ACTUAL.nombre,
                responsableFisico: resp,
                fecha: new Date().toLocaleDateString(),
                hora: new Date().toLocaleTimeString()
            };

            try {
                await fetch(`${API_URL}/movimientos`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });

                alert(`‚úÖ ${tipo} REGISTRADO CORRECTAMENTE.`);
                document.getElementById('respRetiro').value = '';
                document.getElementById('montRetiro').value = '';
                
                if(tipo === 'CIERRE FINAL') location.reload(); // Reinicio forzoso para seguridad

            } catch (e) {
                alert("ERROR: No se pudo registrar el retiro en el servidor.");
            }
        }

        async function cargarCajaDB() {
            const lista = document.getElementById('listaMovimientosDB');
            lista.innerHTML = "<div style='padding:20px; text-align:center; font-weight:bold;'>üîÑ Conectando a la Nube...</div>";

            try {
                const res = await fetch(`${API_URL}/movimientos`);
                const data = await res.json();
                
                lista.innerHTML = "";
                let sumVentas = 0;
                let sumRetiros = 0;

                // Renderizado Detallado
                data.forEach(m => {
                    // Calculo interno
                    if(m.tipo === 'VENTA') sumVentas += (m.pagoReal || 0);
                    if(m.tipo.includes('RETIRO') || m.tipo.includes('CIERRE')) sumRetiros += m.monto;

                    // Logica de Visualizaci√≥n
                    if(USUARIO_ACTUAL.rol >= 2) {
                        // DUE√ëO VE TODO (HUELLA FORENSE)
                        let colorTipo = m.tipo === 'VENTA' ? 'green' : (m.tipo === 'GASTO' ? 'orange' : 'red');
                        lista.innerHTML += `
                            <div style="padding:20px; border-bottom:1px solid #ccc; background:#fff;">
                                <span class="forense-tag">[${m.fecha} ${m.hora}] - REGISTR√ì: ${m.usuarioRegistra}</span>
                                <div style="display:flex; justify-content:space-between; align-items:center;">
                                    <strong style="color:${colorTipo}; font-size:18px;">${m.tipo}</strong>
                                    <strong style="font-size:20px;">$ ${m.monto.toLocaleString()}</strong>
                                </div>
                                <div style="font-size:14px; color:#555; margin-top:5px;">
                                    Responsable F√≠sico: <b>${m.responsableFisico}</b> | Cliente: ${m.cliente || '-'}
                                </div>
                            </div>
                        `;
                    } else if(USUARIO_ACTUAL.rol === 1 && m.tipo.includes('RETIRO')) {
                        // VENDEDOR SOLO VE CONFIRMACIONES DE RETIRO
                        lista.innerHTML += `
                            <div style="padding:15px; border-bottom:1px solid #ccc; color:#444;">
                                ‚úÖ ${m.hora} - ${m.tipo} - CONFIRMADO
                            </div>
                        `;
                    }
                });

                // Actualizar Alerta Auditoria (Solo U2)
                if(USUARIO_ACTUAL.rol >= 2) {
                    const diff = sumVentas - sumRetiros;
                    const alerta = document.getElementById('alertaAuditCaja');
                    alerta.innerHTML = `
                        ENTRADAS (Ventas Efvo): $ ${sumVentas.toLocaleString()} <br>
                        SALIDAS (Retiros): $ ${sumRetiros.toLocaleString()} <br>
                        <hr style="border-color:rgba(255,255,255,0.3); margin:15px 0;">
                        CAJA F√çSICA TE√ìRICA: $ ${diff.toLocaleString()}
                    `;
                    alerta.style.background = diff >= 0 ? "var(--verde-ok)" : "var(--rojo-fosfo)";
                }

            } catch (e) {
                lista.innerHTML = "‚ùå Error recuperando historial. Verifique conexi√≥n.";
            }
        }

        // ------------------------------------------------------------------
        // 6. GASTOS VARIOS (CONEXI√ìN DB)
        // ------------------------------------------------------------------
        async function guardarGastoDB() {
            const detalle = document.getElementById('gasDetalle').value.toUpperCase();
            const monto = parseInt(document.getElementById('gasMonto').value) || 0;

            if(!detalle || monto <= 0) return alert("DATOS INV√ÅLIDOS");

            try {
                await fetch(`${API_URL}/movimientos`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        tipo: "GASTO",
                        monto: monto,
                        cliente: detalle, // Usamos campo cliente para guardar detalle
                        usuarioRegistra: USUARIO_ACTUAL.nombre,
                        responsableFisico: "CAJA CHICA",
                        fecha: new Date().toLocaleDateString(),
                        hora: new Date().toLocaleTimeString()
                    })
                });

                alert("GASTO REGISTRADO (Restado de Caja)");
                document.getElementById('gasDetalle').value = '';
                document.getElementById('gasMonto').value = '';
            } catch (e) { alert("Error al guardar gasto"); }
        }

        // ------------------------------------------------------------------
        // 7. DEUDORES Y ESTAD√çSTICAS
        // ------------------------------------------------------------------
        async function cargarDeudoresDB(orden = 'monto') {
            const lista = document.getElementById('listaDeudoresDB');
            lista.innerHTML = "Consultando base de datos...";

            try {
                // Aqu√≠ deber√≠amos llamar a una ruta espec√≠fica, simulamos con b√∫squeda general
                const res = await fetch(`${API_URL}/clientes`); 
                const clientes = await res.json(); 

                // Filtramos solo los que tienen deuda
                let deudores = clientes.filter(c => c.deudaActual > 0);

                // Ordenamiento
                if(orden === 'monto') deudores.sort((a,b) => b.deudaActual - a.deudaActual);
                else deudores.sort((a,b) => a.nombre.localeCompare(b.nombre));

                lista.innerHTML = `
                    <table>
                        <thead>
                            <tr style="background:#000; color:white;">
                                <th style="color:white;">CLIENTE</th>
                                <th style="color:white; text-align:right;">DEUDA TOTAL</th>
                            </tr>
                        </thead>
                        <tbody>
                        ${deudores.map(d => `
                            <tr>
                                <td>${d.nombre}</td>
                                <td style="text-align:right; font-weight:900; color:red; font-size:22px;">$ ${d.deudaActual.toLocaleString()}</td>
                            </tr>
                        `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (e) {
                lista.innerHTML = "Error cargando deudores.";
            }
        }

        async function cargarProveedoresDB() {
            const cont = document.getElementById('contProveedoresDB');
            const sel = document.getElementById('selProvDB');
            
            // Simulaci√≥n de datos (En realidad vendr√≠an de API /receptores)
            const proveedores = [
                {id:1, nombre: "MERCADO CENTRAL", saldo: 150000},
                {id:2, nombre: "DISTRIBUIDORA SUR", saldo: 50000},
                {id:3, nombre: "LOG√çSTICA OESTE", saldo: 25000}
            ];

            cont.innerHTML = "";
            sel.innerHTML = "<option value=''>SELECCIONAR PROVEEDOR</option>";

            proveedores.forEach(p => {
                cont.innerHTML += `
                    <div style="padding:20px; border:2px solid #ccc; margin-bottom:10px; background:#fff; display:flex; justify-content:space-between;">
                        <strong>${p.nombre}</strong>
                        <div style="color:red; font-weight:bold;">Saldo Vivo: $${p.saldo.toLocaleString()}</div>
                    </div>`;
                sel.innerHTML += `<option value="${p.id}">${p.nombre}</option>`;
            });
        }

        async function pagoManualProvDB() {
            // Esta funci√≥n deber√≠a conectar con la API real
            const monto = document.getElementById('montProv').value;
            alert(`PAGO DE $${monto} REGISTRADO EN HUELLA FORENSE (Salida Manual).`);
        }

        async function calcularVeredictoDB() {
            const div = document.getElementById('resultEstDB');
            div.innerHTML = "<div style='padding:20px; background:#000; color:white;'><h2>CALCULANDO...</h2></div>";
            
            try {
                const res = await fetch(`${API_URL}/veredicto`, { method:'POST', body:JSON.stringify({fechas:'all'})});
                const data = await res.json();
                
                div.innerHTML = `
                    <div style="background:#000; color:white; padding:40px; border-radius:15px; border:6px solid var(--verde-ok); box-shadow:0 10px 30px rgba(0,0,0,0.5);">
                        <h2 style="color:var(--verde-ok); font-size:50px; margin:0; text-shadow:0 0 10px green;">NETA: $ ${data.gananciaNeta.toLocaleString()}</h2>
                        <hr style="border-color:#333; margin:20px 0;">
                        <div style="text-align:left; font-family:'Roboto Mono'; font-size:18px; line-height:2;">
                            <p> (+) VENTAS TOTALES: $ ${data.ventas.toLocaleString()}</p>
                            <p> (-) GASTOS OPERATIVOS: $ ${data.gastos.toLocaleString()}</p>
                            <p style="color:orange;"> (i) DIFERENCIA F√çSICA CAJA: $ ${data.diferenciaCaja.toLocaleString()}</p>
                        </div>
                    </div>
                `;
            } catch(e) {
                div.innerHTML = "Error calculando estad√≠sticas.";
            }
        }

        // UTILIDAD DE INTERFAZ (TOGGLE)
        function toggle(id) {
            const panel = document.getElementById(id);
            if(panel.style.display === 'block') panel.style.display = 'none';
            else panel.style.display = 'block';
        }
    </script>
</body>
</html>
