<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Gesti√≥n Comercial PRO</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .contenedor { width: 100%; max-width: 650px; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); }
        .seccion { border: 1px solid #e0e0e0; padding: 15px; border-radius: 10px; margin-bottom: 20px; background: #fff; }
        .btn { padding: 15px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 10px; }
        .btn-verde { background: #28a745; color: white; }
        .btn-azul { background: #007bff; color: white; }
        .btn-rojo { background: #dc3545; color: white; }
        .btn-gris { background: #6c757d; color: white; }
        .deuda-box { font-size: 36px; color: #d32f2f; text-align: center; font-weight: bold; background: #ffebee; padding: 20px; border-radius: 10px; margin: 15px 0; }
        .movimiento { display: grid; grid-template-columns: 1fr 1fr 1fr; padding: 10px; border-bottom: 1px solid #eee; font-size: 13px; }
        .compra-txt { color: #c53030; font-weight: bold; }
        .pago-txt { color: #276749; font-weight: bold; }
        #sugerencias { position: absolute; background: white; border: 1px solid #ccc; width: 90%; z-index: 100; border-radius: 8px; }
        .sug-item { padding: 14px; cursor: pointer; border-bottom: 1px solid #eee; }
        .receptor-link { color: blue; text-decoration: underline; cursor: pointer; }
        @media print { .no-print { display: none; } }
    </style>
</head>
<body>

<div id="bloqueo" class="no-print">
    <h1>ü•¶ Acceso Requerido</h1>
    <input type="password" id="passAcceso" placeholder="Contrase√±a" style="width: 250px; text-align: center; padding: 10px;">
    <button class="btn btn-verde" style="width: 250px;" onclick="validarAcceso()">ENTRAR</button>
</div>

<div class="contenedor" id="contenidoWeb" style="display:none;">
    <div id="mainUI" class="no-print">
        <h2>üîç Buscador</h2>
        <input type="text" id="inputBusqueda" placeholder="Nombre o Tel√©fono..." oninput="autoCompletar()" autocomplete="off" style="width:100%; padding:15px; font-size:18px;">
        <div id="sugerencias"></div>
        <button class="btn btn-verde" onclick="buscarOCrear()">ABRIR / A√ëADIR CLIENTE</button>
    </div>

    <div id="ficha" style="display:none; margin-top:20px;">
        <div class="seccion">
            <h3 id="nombreDisplay"></h3>
            <input type="text" id="telDisplay" placeholder="Tel√©fono..." style="width:100%; padding:8px; margin-bottom:10px;">
            <div class="deuda-box">$ <span id="deudaDisplay">0</span></div>
            
            <div class="no-print">
                <label>üõí Compra ($):</label><input type="number" id="gasto" value="0" style="width:100%; padding:10px;">
                <label>üíµ Pago ($):</label><input type="number" id="pago" value="0" style="width:100%; padding:10px;">
                <label>üí≥ M√©todo:</label>
                <select id="metodo" onchange="verificarMetodo()" style="width:100%; padding:10px;">
                    <option value="EFECTIVO">Efectivo</option>
                    <option value="TRANSFERENCIA">Transferencia</option>
                    <option value="TARJETA">Tarjeta</option>
                </select>
                <div id="divDestino" style="display:none;">
                    <label>üè¶ Receptor:</label>
                    <select id="destinoProv" style="width:100%; padding:10px;"></select>
                </div>
                <button class="btn btn-azul" onclick="guardarOperacion()">GUARDAR</button>
                <button class="btn btn-gris" onclick="verHistorial()">VER HISTORIAL</button>
                <button class="btn btn-rojo" onclick="cerrarFicha()">CERRAR</button>
            </div>

            <div id="historialSeccion" style="display:none; margin-top:20px;">
                <h4>üìã Historial Detallado</h4>
                <div id="listaHistorial"></div>
                <button class="btn btn-gris no-print" onclick="window.print()">IMPRIMIR PDF</button>
            </div>
        </div>
    </div>

    <div class="seccion no-print" style="margin-top:40px;">
        <h3>üìä Resumen de Hoy</h3>
        <button class="btn btn-gris" onclick="toggleD('resumenDetalle')">Ver Caja y Deudores</button>
        <div id="resumenDetalle" style="display:none;">
            <p>Efectivo: <b id="cajaEfe">$0</b></p>
            <p>Transferencia: <b id="cajaTra">$0</b></p>
            <p>Tarjeta: <b id="cajaTar">$0</b></p>
            <hr>
            <h4>Gente que debe hoy:</h4>
            <div id="listaDeudoresHoy"></div>
        </div>
    </div>

    <div class="seccion no-print">
        <h3>üè¶ Receptores</h3>
        <div id="listaReceptores"></div>
        <hr>
        <input type="text" id="nuevoR_nom" placeholder="Nombre Receptor">
        <input type="number" id="nuevoR_mon" placeholder="Cupo/Deuda Inicial">
        <button class="btn btn-azul" onclick="crearReceptor()">A√ëADIR O ACTUALIZAR</button>
    </div>
</div>

<script>
    const API = "/api";
    const CLAVE = "2026";

    window.onload = () => { if(localStorage.getItem('verduOK') === 'si') mostrar(); };
    function validarAcceso() { if(document.getElementById('passAcceso').value === CLAVE) { localStorage.setItem('verduOK', 'si'); mostrar(); } else alert("Clave Incorrecta"); }
    function mostrar() { document.getElementById('bloqueo').style.display = 'none'; document.getElementById('contenidoWeb').style.display = 'block'; refrescarTodo(); }
    function cerrarFicha() { document.getElementById('ficha').style.display = 'none'; document.getElementById('mainUI').style.display = 'block'; }
    function toggleD(id) { const e = document.getElementById(id); e.style.display = e.style.display === 'none' ? 'block' : 'none'; }

    async function refrescarTodo() {
        const r1 = await fetch(`${API}/receptores`);
        const recs = await r1.json();
        document.getElementById('listaReceptores').innerHTML = recs.map(r => `
            <div style="padding:10px; border-bottom:1px solid #eee;">
                <b class="receptor-link" onclick="verHistorialReceptor('${r.nombre}')">${r.nombre}</b>: 
                <span style="color:red;">Faltan $${r.saldoRestante}</span> / Total $${r.montoObjetivo}
            </div>`).join('');
        document.getElementById('destinoProv').innerHTML = recs.map(r => `<option value="${r.nombre}">${r.nombre}</option>`).join('');

        const r2 = await fetch(`${API}/caja-hoy`);
        const caja = await r2.json();
        document.getElementById('cajaEfe').innerText = `$${caja.totales.EFECTIVO}`;
        document.getElementById('cajaTra').innerText = `$${caja.totales.TRANSFERENCIA}`;
        document.getElementById('cajaTar').innerText = `$${caja.totales.TARJETA}`;
        document.getElementById('listaDeudoresHoy').innerHTML = caja.deudores.map(d => `<p>${d.nombre}: <b>$${d.monto}</b></p>`).join('');
    }

    async function autoCompletar() {
        const val = document.getElementById('inputBusqueda').value;
        if(val.length < 2) return;
        const res = await fetch(`${API}/sugerencias/${val}`);
        const data = await res.json();
        document.getElementById('sugerencias').innerHTML = data.map(c => `<div class="sug-item" onclick="cargarFicha('${c.nombre}','${c.telefono}','${c.deuda}')">${c.nombre} (${c.telefono})</div>`).join('');
        document.getElementById('sugerencias').style.display = 'block';
    }

    async function buscarOCrear() {
        const val = document.getElementById('inputBusqueda').value.toUpperCase();
        const res = await fetch(`${API}/clientes/${val}`);
        const c = await res.json();
        cargarFicha(c.nombre, c.telefono, c.deuda);
    }

    function cargarFicha(nom, tel, deu) {
        document.getElementById('nombreDisplay').innerText = nom;
        document.getElementById('telDisplay').value = tel || "";
        document.getElementById('deudaDisplay').innerText = deu;
        document.getElementById('ficha').style.display = 'block';
        document.getElementById('mainUI').style.display = 'none';
        document.getElementById('sugerencias').style.display = 'none';
    }

    async function guardarOperacion() {
        const op = {
            cliente: document.getElementById('nombreDisplay').innerText,
            compra: parseFloat(document.getElementById('gasto').value) || 0,
            pago: parseFloat(document.getElementById('pago').value) || 0,
            metodo: document.getElementById('metodo').value,
            destino: document.getElementById('destinoProv').value
        };
        await fetch(`${API}/operaciones`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(op) });
        alert("¬°Guardado!");
        cerrarFicha();
        refrescarTodo();
    }

    async function verHistorial() {
        const n = document.getElementById('nombreDisplay').innerText;
        const res = await fetch(`${API}/historial/${n}`);
        const data = await res.json();
        document.getElementById('listaHistorial').innerHTML = data.map(h => `
            <div class="movimiento">
                <span>${new Date(h.fecha).toLocaleString()}</span>
                <span class="${h.compra > 0 ? 'compra-txt' : ''}">${h.compra > 0 ? 'Compra: $'+h.compra : 'PAGO'}</span>
                <span class="${h.pago > 0 ? 'pago-txt' : ''}">${h.pago > 0 ? 'Pago: $'+h.pago : '-'}</span>
            </div>`).join('');
        document.getElementById('historialSeccion').style.display = 'block';
    }

    async function verHistorialReceptor(nom) {
        const res = await fetch(`${API}/historial-receptor/${nom}`);
        const data = await res.json();
        alert("Historial de " + nom + ":\n" + data.map(h => `${new Date(h.fecha).toLocaleDateString()} - De ${h.cliente}: $${h.pago}`).join('\n'));
    }

    async function crearReceptor() {
        const p = prompt("Clave:"); if(p!==CLAVE) return;
        await fetch(`${API}/receptores`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({nombre: document.getElementById('nuevoR_nom').value, monto: document.getElementById('nuevoR_mon').value}) });
        refrescarTodo();
    }

    function verificarMetodo() { document.getElementById('divDestino').style.display = document.getElementById('metodo').value === 'TRANSFERENCIA' ? 'block' : 'none'; }
</script>
</body>
</html>
