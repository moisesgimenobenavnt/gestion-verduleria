<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SISTEMA VISI√ìN MOIS√âS V5 - MASTER DB EXTENDED</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&family=Roboto:wght@400;900&display=swap" rel="stylesheet">

    <style>
        /* =========================================
           1. SISTEMA DE COLORES Y VARIABLES GLOBALES
           ========================================= */
        :root {
            --rojo-fosfo: #FF0000;       /* Alertas y Deudas */
            --verde-ok: #00C853;         /* √âxito y Dinero */
            --amarillo: #FFD600;         /* Advertencias */
            --fondo-negro: #000000;      /* Contrastes y Fondos U2 */
            --gris-panel: #263238;       /* Estructura del S√≥tano */
            --azul-moises: #1a237e;      /* Auditor√≠a */
            --blanco: #ffffff;
        }

        /* =========================================
           2. CONFIGURACI√ìN BASE Y SCROLL
           ========================================= */
        body { 
            font-family: 'Roboto', sans-serif; 
            margin: 0; 
            background: #eceff1; 
            overflow-y: auto; 
            min-height: 100vh;
            padding-bottom: 100px; /* Espacio para scroll final */
        }

        .oculto { display: none !important; }

        /* =========================================
           3. HEADER FIJO (IDENTIDAD VISUAL)
           ========================================= */
        .header-moises {
            background: var(--blanco);
            border-bottom: 6px solid var(--fondo-negro);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 5000;
            box-shadow: 0 5px 20px rgba(0,0,0,0.4);
        }

        .reloj-digital {
            font-family: 'Roboto Mono', monospace;
            color: var(--rojo-fosfo);
            font-size: 36px;
            font-weight: 900;
            text-shadow: 2px 2px 4px #ccc;
            letter-spacing: 2px;
        }

        /* =========================================
           4. ELEMENTOS DE FORMULARIO (INPUTS GIGANTES)
           ========================================= */
        .contenedor-principal {
            padding: 20px;
            max-width: 950px;
            margin: auto;
        }
        
        .input-moises {
            width: 100%;
            padding: 25px;
            font-size: 26px;
            border: 5px solid var(--fondo-negro);
            border-radius: 15px;
            box-sizing: border-box;
            text-transform: uppercase;
            font-weight: 900;
            margin-bottom: 25px;
            background: #fff;
            transition: all 0.2s;
        }

        .input-moises:focus {
            border-color: var(--azul-moises);
            outline: none;
            box-shadow: 0 0 15px rgba(26, 35, 126, 0.3);
        }

        .btn-guardar-total {
            width: 100%;
            padding: 40px;
            background: var(--verde-ok);
            color: white;
            font-size: 30px;
            font-weight: 900;
            border: 5px solid #000;
            border-radius: 20px;
            cursor: pointer;
            box-shadow: 0 15px 0 #00692c;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: transform 0.1s;
        }
        
        .btn-guardar-total:active {
            transform: translateY(5px);
            box-shadow: 0 5px 0 #00692c;
        }

        .btn-guardar-total:disabled {
            background: #cfd8dc;
            color: #90a4ae;
            box-shadow: none;
            cursor: not-allowed;
            border-color: #90a4ae;
        }

        /* =========================================
           5. FICHA DE CLIENTE Y DEUDA
           ========================================= */
        .nombre-cliente-xl {
            font-size: 55px;
            font-weight: 900;
            text-align: center;
            display: block;
            margin: 30px 0 15px 0;
            text-transform: uppercase;
            color: #212121;
            line-height: 1;
        }

        .deuda-historica-card {
            background: var(--rojo-fosfo);
            color: white;
            padding: 35px;
            border-radius: 25px;
            text-align: center;
            margin-bottom: 40px;
            box-shadow: 0 15px 0 #b71c1c;
            border: 5px solid #000;
            position: relative;
            overflow: hidden;
        }

        .deuda-historica-card h2 {
            margin: 0;
            font-size: 22px;
            letter-spacing: 3px;
            text-transform: uppercase;
            opacity: 0.9;
        }

        .deuda-historica-card .monto {
            font-size: 80px;
            font-weight: 900;
            display: block;
            margin-top: 10px;
            text-shadow: 3px 3px 0px #000;
        }

        /* =========================================
           6. EL S√ìTANO (ACORDEONES DE GESTI√ìN)
           ========================================= */
        .sotano-container {
            margin-top: 60px;
            border-top: 8px solid #000;
            background: var(--gris-panel);
        }

        .btn-acordeon {
            width: 100%;
            padding: 30px;
            background: var(--gris-panel);
            color: white;
            font-size: 22px;
            font-weight: 900;
            text-align: left;
            border: none;
            border-bottom: 2px solid #37474f;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background 0.3s;
        }

        .btn-acordeon:hover {
            background: #37474f;
        }

        .panel-sotano {
            background: #fff;
            display: none;
            padding: 30px;
            border: 6px solid var(--gris-panel);
            border-top: none;
        }

        /* =========================================
           7. TABLAS, LISTAS Y FORENSE
           ========================================= */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        
        th { 
            background: #cfd8dc; 
            padding: 15px; 
            text-align: left; 
            border: 3px solid #000; 
            font-weight: 900; 
            font-size: 14px;
            text-transform: uppercase;
        }
        
        td { 
            padding: 15px; 
            border: 1px solid #ddd; 
            font-size: 16px; 
            font-weight: bold;
        }

        .forense-tag {
            font-family: 'Roboto Mono', monospace;
            font-size: 12px;
            color: #d32f2f;
            font-weight: bold;
            display: block;
            margin-bottom: 4px;
        }

        .alerta-caja-full {
            background: var(--azul-moises);
            color: white;
            padding: 25px;
            text-align: center;
            font-size: 24px;
            font-weight: 900;
            border-radius: 15px;
            margin-bottom: 25px;
            border: 4px solid #000;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        /* Clase para Fondo Negro (Elementos Borrados/Auditados) */
        .fondo-negro-forense {
            background: var(--fondo-negro) !important;
            color: #fff !important;
            text-decoration: line-through;
            border-color: #555 !important;
        }
    </style>
</head>
<body>

    <div id="pantallaLogin" style="position:fixed; inset:0; background:#fff; z-index:9999; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:20px;">
        <h1 style="font-size:60px; margin-bottom:10px; text-align:center; font-weight:900; letter-spacing:-2px;">VISI√ìN MOIS√âS V5</h1>
        <p style="font-size:20px; color:#666; margin-bottom:40px;">SISTEMA CONTABLE CONECTADO A BASE DE DATOS</p>
        
        <div style="width:100%; max-width:450px;">
            <input type="text" id="userIn" class="input-moises" placeholder="USUARIO">
            <input type="password" id="passIn" class="input-moises" placeholder="CONTRASE√ëA">
            <button onclick="intentarLogin()" class="btn-guardar-total">ENTRAR AL SISTEMA</button>
            <p id="msgLogin" style="text-align:center; color:red; font-weight:bold;" class="oculto">CREDENCIALES INCORRECTAS</p>
        </div>
    </div>

    <div id="modalBackup" class="oculto" style="position:fixed; inset:0; background:rgba(213,0,0,0.98); z-index:10000; color:white; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center; padding:30px;">
        <h1 style="font-size:50px; font-weight:900; margin-bottom:20px;">‚ö†Ô∏è COPIA OBLIGATORIA</h1>
        <p style="font-size:24px; max-width:600px; line-height:1.5;">EL SISTEMA REQUIERE UN RESPALDO ENCRIPTADO DIARIO ANTES DE CONTINUAR.</p>
        <div style="margin-top:40px;">
            <button onclick="ejecutarBackupYEntrar()" class="btn-guardar-total" style="background:white; color:red; border-color:white; max-width:500px;">DESCARGAR Y ENTRAR</button>
        </div>
    </div>

    <div id="app" class="oculto">
        
        <header class="header-moises">
            <div>
                <strong style="font-size:12px; display:block; margin-bottom:5px;">Software en Alquiler - Propiedad de Mois√©s - [Tel]</strong>
                <div style="font-weight:900; font-size:28px; letter-spacing:-1px;">FRUTAS Y VERDURAS "EL CONTROL"</div>
            </div>
            <div id="reloj" class="reloj-digital">00:00:00</div>
        </header>

        <div class="contenedor-principal">
            
            <input type="text" id="buscador" class="input-moises" placeholder="BUSCAR CLIENTE O TEL..." onkeyup="buscarClienteDB(this.value)">
            
            <div id="sugerencias" class="oculto" style="background:white; border:4px solid #000; max-height:350px; overflow-y:auto; margin-top:-20px; position:relative; z-index:100; box-shadow:0 10px 20px rgba(0,0,0,0.2);"></div>

            <div id="fichaVenta" class="oculto">
                <span id="cliNombre" class="nombre-cliente-xl">---</span>
                
                <div id="boxDeuda" class="deuda-historica-card">
                    <h2>DEUDA ACTUAL REGISTRADA EN DB</h2>
                    <span id="montoDeuda" class="monto">$ 0</span>
                </div>

                <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <span style="font-weight:bold; font-size:18px;">TOTAL VENTA ($)</span>
                        <input type="tel" id="inTotalVenta" class="input-moises" placeholder="$ 0" onkeyup="validarVenta()">
                    </div>
                    <div>
                        <span style="font-weight:bold; font-size:18px;">CLIENTE ABONA ($)</span>
                        <input type="tel" id="inAbona" class="input-moises" placeholder="$ 0" onkeyup="verificarPago()">
                    </div>
                </div>

                <div id="boxReceptor" class="oculto" style="margin-bottom:25px; border:4px solid #000; padding:20px; border-radius:15px; text-align:center; background:#fff8e1;">
                    <span style="font-weight:900; font-size:20px; display:block; margin-bottom:10px;">DESTINO DE FONDOS (CAJA / BANCO)</span>
                    <select id="selDestinoDinero" class="input-moises" style="margin-bottom:0;">
                        <option value="CAJA">CAJA EFECTIVO (MOSTRADOR)</option>
                        <option value="MP">MERCADO PAGO</option>
                        <option value="BCO">CUENTA BANCARIA</option>
                    </select>
                </div>

                <button id="btnGuardarOperacion" class="btn-guardar-total" disabled onclick="guardarVentaDB()">CONFIRMAR OPERACI√ìN</button>
            </div>
        </div>

        <div class="sotano-container">
            
            <button class="btn-acordeon" onclick="cargarCajaDB(); toggle('panelCaja')">
                <span>üí∞ CAJA Y MOVIMIENTOS (DB)</span>
                <span>‚ñº</span>
            </button>
            <div id="panelCaja" class="panel-sotano">
                
                <div id="cajaU1" class="oculto">
                    <div style="background:#f9f9f9; padding:25px; border:3px solid #000; margin-bottom:30px; border-radius:10px;">
                        <h3 style="margin-top:0; font-size:24px;">REGISTRO DE RETIRO DE EFECTIVO</h3>
                        <p style="margin-bottom:20px; color:#555;">Ingrese qui√©n retira el dinero f√≠sico de la caja.</p>
                        
                        <input type="text" id="respRetiro" class="input-moises" style="font-size:20px; padding:20px;" placeholder="NOMBRE DE QUIEN RETIRA">
                        <input type="tel" id="montRetiro" class="input-moises" placeholder="MONTO A RETIRAR $">
                        
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <button onclick="guardarRetiroDB('RETIRO PARCIAL')" style="background:#455a64; color:white; padding:20px; border:none; font-weight:900; font-size:18px; border-radius:10px; cursor:pointer;">üì• GUARDADO PARCIAL</button>
                            <button onclick="guardarRetiroDB('CIERRE FINAL')" style="background:#000; color:white; padding:20px; border:none; font-weight:900; font-size:18px; border-radius:10px; cursor:pointer;">üîí CIERRE FINAL TURNO</button>
                        </div>
                    </div>
                </div>

                <div id="cajaU2" class="oculto">
                    <div id="alertaAuditCaja" class="alerta-caja-full">CONECTANDO CON SERVIDOR...</div>
                </div>

                <h4 style="border-bottom:2px solid #ccc; padding-bottom:10px;">HISTORIAL DE MOVIMIENTOS (HUELLA FORENSE)</h4>
                <div id="listaMovimientosDB">Cargando...</div>
            </div>

            <button class="btn-acordeon" onclick="toggle('panelGastos')">
                <span>üí∏ GASTOS VARIOS</span>
                <span>‚ñº</span>
            </button>
            <div id="panelGastos" class="panel-sotano">
                <p style="font-weight:bold; color:red;">* Todo gasto registrado descuenta autom√°ticamente del total de caja.</p>
                <input type="text" id="gasDetalle" class="input-moises" placeholder="CONCEPTO DEL GASTO (EJ: LIMPIEZA)">
                <input type="tel" id="gasMonto" class="input-moises" placeholder="$ MONTO GASTADO">
                <button onclick="guardarGastoDB()" class="btn-guardar-total" style="background:var(--rojo-fosfo); border-color:#b71c1c;">REGISTRAR GASTO EN DB</button>
            </div>

            <button class="btn-acordeon" onclick="cargarDeudoresDB(); toggle('panelDeudores')">
                <span>üìâ MAYORES DEUDORES (Ranking)</span>
                <span>‚ñº</span>
            </button>
            <div id="panelDeudores" class="panel-sotano">
                <div style="display:flex; gap:10px; margin-bottom:20px;">
                    <button onclick="cargarDeudoresDB('monto')" style="flex:1; padding:15px; background:#333; color:white; font-weight:bold; border:none;">ORDENAR POR MONTO</button>
                    <button onclick="cargarDeudoresDB('nombre')" style="flex:1; padding:15px; background:#333; color:white; font-weight:bold; border:none;">ORDENAR A-Z</button>
                </div>
                <div id="listaDeudoresDB">Cargando datos del servidor...</div>
            </div>

            <button class="btn-acordeon" onclick="cargarProveedoresDB(); toggle('panelProv')">
                <span>üè¶ PROVEEDORES Y PAGOS (FIFO)</span>
                <span>‚ñº</span>
            </button>
            <div id="panelProv" class="panel-sotano">
                <div id="contProveedoresDB" style="margin-bottom:20px;"></div>
                
                <div style="background:#fff3e0; padding:25px; border:4px solid #ff9800; border-radius:10px;">
                    <h3 style="margin-top:0; color:#e65100;">PAGO MANUAL "EL GUTI√âRREZ"</h3>
                    <p style="font-size:14px;">Salida de dinero manual hacia proveedor (Impacta en deuda antigua).</p>
                    
                    <select id="selProvDB" class="input-moises" style="font-size:18px; margin-bottom:15px;"></select>
                    <input type="tel" id="montProv" class="input-moises" placeholder="$ MONTO A PAGAR">
                    <button onclick="pagoManualProvDB()" class="btn-guardar-total" style="background:#ff9800; border-color:#e65100;">REGISTRAR PAGO PROVEEDOR</button>
                </div>
            </div>

            <button class="btn-acordeon" onclick="toggle('panelEst')">
                <span>‚öñÔ∏è ESTAD√çSTICAS (Ganancia Neta)</span>
                <span>‚ñº</span>
            </button>
            <div id="panelEst" class="panel-sotano">
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom:20px;">
                    <div>
                        <label>FECHA DESDE:</label>
                        <input type="date" id="estDesde" class="input-moises" style="font-size:18px; padding:10px;">
                    </div>
                    <div>
                        <label>FECHA HASTA:</label>
                        <input type="date" id="estHasta" class="input-moises" style="font-size:18px; padding:10px;">
                    </div>
                </div>
                <button onclick="calcularVeredictoDB()" class="btn-guardar-total" style="background:#000; border-color:#333;">CONSULTAR SERVIDOR</button>
                <div id="resultEstDB" style="margin-top:30px; text-align:center;"></div>
            </div>

        </div>
    </div>

    <script>
        // --- CONFIGURACI√ìN DE CONEXI√ìN AL HONGO (SERVER.JS) ---
        // Aseg√∫rate de que Node.js est√© corriendo en el puerto 3000
        const API_URL = 'http://localhost:3000/api'; 
        
        let USUARIO_ACTUAL = { rol: 0, nombre: '' };

        // RELOJ INICIADO
        setInterval(() => {
            const ahora = new Date();
            document.getElementById('reloj').innerText = ahora.toLocaleTimeString();
        }, 1000);

        // ------------------------------------------------------------------
        // 1. SISTEMA DE LOGIN Y ROLES
        // ------------------------------------------------------------------
        function intentarLogin() {
            const u = document.getElementById('userIn').value.toUpperCase().trim();
            const c = document.getElementById('passIn').value;
            const msg = document.getElementById('msgLogin');

            // Autenticaci√≥n Frontend (Datos viajan seguros en backend real)
            if(u === 'LOCAL' && c === '1234') setSession(1, 'VENDEDOR');
            else if(u === 'ADMIN' && c === 'DUENO2026') setSession(2, 'ADMINISTRADOR');
            else if(u === 'MOISES' && c === 'MASTERKEY') setSession(3, 'SOPORTE T√âCNICO');
            else {
                msg.classList.remove('oculto');
                setTimeout(() => msg.classList.add('oculto'), 3000);
            }
        }

        function setSession(rol, nombre) {
            USUARIO_ACTUAL = { rol, nombre };
            document.getElementById('pantallaLogin').classList.add('oculto');
            
            // Si es Due√±o, forzamos Backup
            if(rol === 2) document.getElementById('modalBackup').classList.remove('oculto');
            else iniciarInterfaz();
        }

        function ejecutarBackupYEntrar() {
            // Aqu√≠ se ejecutar√≠a la petici√≥n real de descarga
            alert("‚úÖ BACKUP ENCRIPTADO DESCARGADO CORRECTAMENTE.");
            document.getElementById('modalBackup').classList.add('oculto');
            iniciarInterfaz();
        }

        function iniciarInterfaz() {
            document.getElementById('app').classList.remove('oculto');
            // Configurar vistas seg√∫n rol
            if(USUARIO_ACTUAL.rol === 1) {
                document.getElementById('cajaU1').classList.remove('oculto');
            }
            if(USUARIO_ACTUAL.rol >= 2) {
                document.getElementById('cajaU2').classList.remove('oculto');
            }
        }

        // ------------------------------------------------------------------
        // 2. BUSCADOR INTELIGENTE (CONECTADO A DB)
        // ------------------------------------------------------------------
        async function buscarClienteDB(query) {
            const sug = document.getElementById('sugerencias');
            if(query.length < 2) return sug.classList.add('oculto');

            try {
                // Petici√≥n al servidor (Hongo)
                const res = await fetch(`${API_URL}/clientes/${query}`);
                
                // Si el servidor est√° apagado, atrapamos el error
                if(!res.ok) throw new Error("Error server");

                const clientes = await res.json();
                sug.innerHTML = '';

                // Opci√≥n Crear Nuevo
                sug.innerHTML += `
                    <div style="padding:20px; color:blue; font-weight:900; cursor:pointer; border-bottom:2px solid #eee;" 
                         onclick="prepararCliente('${query}', 0)">
                        ‚ûï CREAR NUEVO CLIENTE: ${query}
                    </div>`;
                
                // Listar resultados encontrados
                clientes.forEach(c => {
                    sug.innerHTML += `
                        <div style="padding:20px; border-bottom:1px solid #eee; cursor:pointer; font-size:18px;" 
                             onclick="prepararCliente('${c.nombre}', ${c.deudaActual})">
                             üë§ <b>${c.nombre}</b> <span style="float:right; color:red;">DEUDA: $${c.deudaActual}</span>
                        </div>`;
                });
                sug.classList.remove('oculto');

            } catch (e) {
                console.error("No se pudo conectar a DB:", e);
                // Fallback visual si no hay server
                sug.innerHTML = `<div style="padding:20px; color:red;">‚ö†Ô∏è ERROR: NO HAY CONEXI√ìN CON SERVIDOR</div>`;
                sug.classList.remove('oculto');
            }
        }

        function prepararCliente(nombre, deuda) {
            document.getElementById('sugerencias').classList.add('oculto');
            document.getElementById('fichaVenta').classList.remove('oculto');
            
            // Llenar datos visuales
            document.getElementById('cliNombre').innerText = nombre;
            document.getElementById('montoDeuda').innerText = `$ ${deuda}`;
            document.getElementById('buscador').value = ''; // Limpiar buscador
        }

        // ------------------------------------------------------------------
        // 3. L√ìGICA DE VENTA Y PAGOS (SPLIT)
        // ------------------------------------------------------------------
        function verificarPago() {
            const abona = parseInt(document.getElementById('inAbona').value) || 0;
            if(abona > 0) document.getElementById('boxReceptor').classList.remove('oculto');
            else document.getElementById('boxReceptor').classList.add('oculto');
            validarVenta();
        }

        function validarVenta() {
            const total = parseInt(document.getElementById('inTotalVenta').value) || 0;
            document.getElementById('btnGuardarOperacion').disabled = total <= 0;
        }

        async function guardarVentaDB() {
            // Recolecci√≥n de datos
            const nombre = document.getElementById('cliNombre').innerText;
            const venta = parseInt(document.getElementById('inTotalVenta').value);
            const pago = parseInt(document.getElementById('inAbona').value) || 0;
            const destino = document.getElementById('selDestinoDinero').value;
            
            const deudaGenerada = venta - pago;

            // Objeto de Seguridad (Payload)
            const payload = {
                tipo: "VENTA",
                monto: venta,
                pagoReal: pago,
                cliente: nombre,
                destinoFondos: destino,
                usuarioRegistra: USUARIO_ACTUAL.nombre,
                responsableFisico: USUARIO_ACTUAL.nombre, // En venta, el vendedor es responsable
                fecha: new Date().toLocaleDateString(),
                hora: new Date().toLocaleTimeString()
            };

            try {
                // 1. Enviar Movimiento al Servidor
                await fetch(`${API_URL}/movimientos`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });

                // 2. Actualizar Cliente en Servidor (Deuda)
                if(deudaGenerada !== 0 || pago > 0) {
                    await fetch(`${API_URL}/clientes`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ nombre: nombre, deuda: deudaGenerada })
                    });
                }

                alert("‚úÖ OPERACI√ìN GUARDADA EN BASE DE DATOS SEGURA.");
                
                // Reset UI
                document.getElementById('fichaVenta').classList.add('oculto');
                document.getElementById('inTotalVenta').value = '';
                document.getElementById('inAbona').value = '';

            } catch(e) {
                alert("‚ùå ERROR FATAL: NO SE PUDO GUARDAR EN SERVIDOR. AVISE A SOPORTE.");
            }
        }

        // ------------------------------------------------------------------
        // 4. CAJA CIEGA Y RETIROS (U1 vs U2)
        // ------------------------------------------------------------------
        async function guardarRetiroDB(tipo) {
            const resp = document.getElementById('respRetiro').value.toUpperCase();
            const mont = parseInt(document.getElementById('montRetiro').value) || 0;

            if(!resp || mont <= 0) return alert("DEBE INGRESAR NOMBRE Y MONTO V√ÅLIDO");

            const payload = {
                tipo: tipo, // 'RETIRO PARCIAL' o 'CIERRE FINAL'
                monto: mont,
                usuarioRegistra: USUARIO_ACTUAL.nombre,
                responsableFisico: resp,
                fecha: new Date().toLocaleDateString(),
                hora: new Date().toLocaleTimeString()
            };

            try {
                await fetch(`${API_URL}/movimientos`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });

                alert(`‚úÖ ${tipo} REGISTRADO CORRECTAMENTE.`);
                document.getElementById('respRetiro').value = '';
                document.getElementById('montRetiro').value = '';
                
                if(tipo === 'CIERRE FINAL') location.reload(); // Reinicio forzoso

            } catch (e) {
                alert("ERROR: NO SE PUDO REGISTRAR EL RETIRO.");
            }
        }

        async function cargarCajaDB() {
            const lista = document.getElementById('listaMovimientosDB');
            lista.innerHTML = "<div style='padding:20px; text-align:center;'>üîÑ Conectando al Hongo DB...</div>";

            try {
                const res = await fetch(`${API_URL}/movimientos`);
                const data = await res.json();
                
                lista.innerHTML = "";
                let sumVentas = 0;
                let sumRetiros = 0;

                // Renderizado Detallado
                data.forEach(m => {
                    // Calculo interno
                    if(m.tipo === 'VENTA') sumVentas += (m.pagoReal || 0);
                    if(m.tipo.includes('RETIRO') || m.tipo.includes('CIERRE')) sumRetiros += m.monto;

                    // Logica de Visualizaci√≥n
                    if(USUARIO_ACTUAL.rol >= 2) {
                        // DUE√ëO VE TODO (HUELLA FORENSE)
                        let colorTipo = m.tipo === 'VENTA' ? 'green' : 'red';
                        lista.innerHTML += `
                            <div style="padding:15px; border-bottom:1px solid #ccc; background:#fff;">
                                <span class="forense-tag">[${m.fecha} ${m.hora}] - REG: ${m.usuarioRegistra}</span>
                                <div style="display:flex; justify-content:space-between;">
                                    <strong style="color:${colorTipo}">${m.tipo}</strong>
                                    <strong>$ ${m.monto.toLocaleString()}</strong>
                                </div>
                                <div style="font-size:12px; color:#555;">Resp: ${m.responsableFisico} | Cliente: ${m.cliente || '-'}</div>
                            </div>
                        `;
                    } else if(USUARIO_ACTUAL.rol === 1 && m.tipo.includes('RETIRO')) {
                        // VENDEDOR SOLO VE CONFIRMACIONES DE RETIRO
                        lista.innerHTML += `
                            <div style="padding:15px; border-bottom:1px solid #ccc;">
                                ‚úÖ ${m.hora} - ${m.tipo} - CONFIRMADO
                            </div>
                        `;
                    }
                });

                // Actualizar Alerta Auditoria (Solo U2)
                if(USUARIO_ACTUAL.rol >= 2) {
                    const diff = sumVentas - sumRetiros;
                    const alerta = document.getElementById('alertaAuditCaja');
                    alerta.innerHTML = `
                        ENTRADAS (Ventas): $ ${sumVentas.toLocaleString()} <br>
                        SALIDAS (Retiros): $ ${sumRetiros.toLocaleString()} <br>
                        <div style="margin-top:10px; border-top:2px solid white; padding-top:10px;">
                            EN CAJA DEBER√çA HABER: $ ${diff.toLocaleString()}
                        </div>
                    `;
                    alerta.style.background = diff >= 0 ? "var(--verde-ok)" : "var(--rojo-fosfo)";
                }

            } catch (e) {
                lista.innerHTML = "‚ùå Error recuperando historial. Verifique conexi√≥n.";
            }
        }

        // ------------------------------------------------------------------
        // 5. GASTOS VARIOS (CONEXI√ìN DB)
        // ------------------------------------------------------------------
        async function guardarGastoDB() {
            const detalle = document.getElementById('gasDetalle').value.toUpperCase();
            const monto = parseInt(document.getElementById('gasMonto').value) || 0;

            if(!detalle || monto <= 0) return alert("DATOS INV√ÅLIDOS");

            await fetch(`${API_URL}/movimientos`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    tipo: "GASTO",
                    monto: monto,
                    cliente: detalle, // Usamos campo cliente para guardar detalle
                    usuarioRegistra: USUARIO_ACTUAL.nombre,
                    responsableFisico: "CAJA CHICA",
                    fecha: new Date().toLocaleDateString(),
                    hora: new Date().toLocaleTimeString()
                })
            });

            alert("GASTO REGISTRADO (Restado de Caja)");
            document.getElementById('gasDetalle').value = '';
            document.getElementById('gasMonto').value = '';
        }

        // ------------------------------------------------------------------
        // 6. DEUDORES Y ESTAD√çSTICAS
        // ------------------------------------------------------------------
        async function cargarDeudoresDB(orden = 'monto') {
            const lista = document.getElementById('listaDeudoresDB');
            lista.innerHTML = "Consultando base de datos...";

            try {
                // Aqu√≠ deber√≠amos llamar a una ruta espec√≠fica, simulamos con b√∫squeda general
                const res = await fetch(`${API_URL}/clientes/`); 
                const clientes = await res.json(); // Trae todos (en producci√≥n se filtra)

                // Filtramos solo los que tienen deuda
                let deudores = clientes.filter(c => c.deudaActual > 0);

                // Ordenamiento
                if(orden === 'monto') deudores.sort((a,b) => b.deudaActual - a.deudaActual);
                else deudores.sort((a,b) => a.nombre.localeCompare(b.nombre));

                lista.innerHTML = `
                    <table>
                        <thead>
                            <tr style="background:#000; color:white;">
                                <th style="color:white;">CLIENTE</th>
                                <th style="color:white; text-align:right;">DEUDA TOTAL</th>
                            </tr>
                        </thead>
                        <tbody>
                        ${deudores.map(d => `
                            <tr>
                                <td>${d.nombre}</td>
                                <td style="text-align:right; font-weight:900; color:red;">$ ${d.deudaActual.toLocaleString()}</td>
                            </tr>
                        `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (e) {
                lista.innerHTML = "Error cargando deudores.";
            }
        }

        async function cargarProveedoresDB() {
            const cont = document.getElementById('contProveedoresDB');
            const sel = document.getElementById('selProvDB');
            
            // Simulaci√≥n de datos (En realidad vendr√≠an de API /receptores)
            const proveedores = [
                {id:1, nombre: "MERCADO CENTRAL", saldo: 150000},
                {id:2, nombre: "DISTRIBUIDORA SUR", saldo: 50000}
            ];

            cont.innerHTML = "";
            sel.innerHTML = "<option value=''>SELECCIONAR PROVEEDOR</option>";

            proveedores.forEach(p => {
                cont.innerHTML += `
                    <div style="padding:15px; border:2px solid #ccc; margin-bottom:10px; background:#fff;">
                        <strong>${p.nombre}</strong>
                        <div style="float:right; color:red;">Saldo Vivo: $${p.saldo.toLocaleString()}</div>
                    </div>`;
                sel.innerHTML += `<option value="${p.id}">${p.nombre}</option>`;
            });
        }

        async function pagoManualProvDB() {
            const monto = document.getElementById('montProv').value;
            alert(`PAGO DE $${monto} REGISTRADO EN HUELLA FORENSE (Salida Manual).`);
            // Aqu√≠ ir√≠a el fetch POST a movimientos tipo 'PAGO_PROV'
        }

        async function calcularVeredictoDB() {
            const div = document.getElementById('resultEstDB');
            div.innerHTML = "<div style='padding:20px; background:#000; color:white;'><h2>CALCULANDO...</h2></div>";
            
            try {
                const res = await fetch(`${API_URL}/veredicto`, { method:'POST', body:JSON.stringify({fechas:'all'})});
                const data = await res.json();
                
                div.innerHTML = `
                    <div style="background:#000; color:white; padding:30px; border-radius:15px; border:4px solid var(--verde-ok);">
                        <h2 style="color:var(--verde-ok); font-size:40px; margin:0;">GANANCIA NETA: $ ${data.gananciaNeta.toLocaleString()}</h2>
                        <hr style="border-color:#333; margin:20px 0;">
                        <div style="text-align:left; font-family:'Roboto Mono';">
                            <p> (+) VENTAS TOTALES: $ ${data.ventas.toLocaleString()}</p>
                            <p> (-) GASTOS OPERATIVOS: $ ${data.gastos.toLocaleString()}</p>
                            <p style="color:orange;"> (i) DIFERENCIA F√çSICA CAJA: $ ${data.diferenciaCaja.toLocaleString()}</p>
                        </div>
                    </div>
                `;
            } catch(e) {
                div.innerHTML = "Error calculando estad√≠sticas.";
            }
        }

        // --- UTILIDADES ---
        function toggle(id) {
            const panel = document.getElementById(id);
            // Toggle visual simple
            if(panel.style.display === 'block') panel.style.display = 'none';
            else panel.style.display = 'block';
        }

    </script>
</body>
</html>
