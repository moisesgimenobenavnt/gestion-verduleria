<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Oriental Gesti√≥n - V. Estable</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; margin: 0; padding: 10px; }
        .contenedor { width: 100%; max-width: 600px; margin: auto; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); box-sizing: border-box; }
        .reloje { text-align: center; font-size: 14px; color: #666; margin-bottom: 15px; font-weight: bold; }
        .deuda-box { font-size: 38px; color: #d32f2f; text-align: center; font-weight: bold; background: #ffebee; padding: 15px; border-radius: 10px; border: 2px solid #ffcdd2; margin: 10px 0; }
        input, select { width: 100%; padding: 12px; margin-top: 5px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        .btn { padding: 15px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 15px; width: 100%; margin-top: 10px; }
        .btn-verde { background: #2e7d32; color: white; }
        .btn-azul { background: #1565c0; color: white; }
        .btn-rojo { background: #c62828; color: white; }
        .btn-gris { background: #546e7a; color: white; }
        .flex-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; font-size: 14px; }
        #sugerencias { position: absolute; background: white; border: 1px solid #ccc; width: 100%; max-width: 550px; z-index: 100; border-radius: 8px; }
        .sug-item { padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; }
        .oculto { display: none; }
        #bloqueo { position: fixed; top:0; left:0; width:100%; height:100%; background:#f0f2f5; z-index:999; display:flex; flex-direction:column; justify-content:center; align-items:center; }
    </style>
</head>
<body>

<div id="bloqueo">
    <h2>üîë Acceso Maestro</h2>
    <input type="password" id="passAcceso" placeholder="PIN de acceso" style="width: 250px; text-align: center;">
    <button class="btn btn-verde" style="width: 250px;" onclick="validarAcceso()">ENTRAR</button>
</div>

<div id="contenidoWeb" class="oculto">
    <div class="contenedor no-print" id="uiBusqueda">
        <h2 style="text-align:center;">üîç Buscar Cliente</h2>
        <input type="text" id="inputBusqueda" placeholder="Nombre o Tel√©fono..." oninput="autoCompletar()" onkeydown="if(event.key==='Enter') buscarOCrear()">
        <div id="sugerencias"></div>
        <button class="btn btn-verde" onclick="buscarOCrear()">ABRIR / CREAR</button>
    </div>

    <div id="ficha" class="contenedor oculto" style="margin-top: 10px;">
        <div class="reloje" id="relojVivo"></div>
        <h3 id="nombreDisplay" style="text-align:center; margin:0;"></h3>
        <div style="display:flex; gap:5px; margin-top:10px;">
            <input type="text" id="telDisplay" placeholder="üìû Tel√©fono...">
            <button class="btn btn-azul" style="width:60px; margin:0;" onclick="guardarTel()">üíæ</button>
        </div>
        <div class="deuda-box">$ <span id="deudaDisplay">0</span></div>
        <div class="no-print">
            <label>üõí Compra ($):</label><input type="text" id="gasto" oninput="formatI(this)">
            <label>üíµ Pago ($):</label><input type="text" id="pago" oninput="formatI(this)">
            <label>üí≥ M√©todo:</label>
            <select id="metodo" onchange="verMetodo()">
                <option value="EFECTIVO">EFECTIVO</option>
                <option value="TRANSFERENCIA">TRANSFERENCIA</option>
                <option value="TARJETA">TARJETA</option>
            </select>
            <div id="divDestino" class="oculto">
                <label>üè¶ Receptor:</label><select id="destinoProv"></select>
            </div>
            <button class="btn btn-verde" onclick="guardarOp()">GUARDAR MOVIMIENTO</button>
            <button class="btn btn-gris" onclick="verHistorial()">VER HISTORIAL</button>
            <button class="btn btn-rojo" onclick="cerrarFicha()">VOLVER</button>
        </div>
        <div id="historialSeccion" class="oculto">
            <hr><div id="listaHistorial"></div>
            <button class="btn btn-gris no-print" onclick="window.print()">IMPRIMIR PDF</button>
        </div>
    </div>

    <div class="contenedor" style="margin-top:20px;">
        <button class="btn btn-gris" onclick="toggle('detCaja')">üìä REPORTES DE HOY</button>
        <div id="detCaja" class="oculto seccion" style="padding:15px; border: 1px solid #ddd; border-radius:10px;">
            <div class="flex-row"><span>Efectivo:</span> <b id="cajaEfe">$0</b></div>
            <div class="flex-row"><span>Transf:</span> <b id="cajaTra">$0</b></div>
            <div class="flex-row"><span>Tarjeta:</span> <b id="cajaTar">$0</b></div>
            <hr>
            <h4>Deudores Activos:</h4>
            <div id="listaDeudores"></div>
        </div>

        <button class="btn btn-gris" onclick="toggle('detRec')">üè¶ RECEPTORES</button>
        <div id="detRec" class="oculto seccion" style="padding:15px; border: 1px solid #ddd; border-radius:10px;">
            <div id="listaReceptores"></div>
            <hr>
            <input type="text" id="rn" placeholder="Nombre">
            <input type="text" id="rm" placeholder="Monto" oninput="formatI(this)">
            <button class="btn btn-azul" onclick="addRec()">A√ëADIR</button>
        </div>
        <button class="btn btn-rojo" style="margin-top:100px;" onclick="location.reload()">SALIR</button>
    </div>
</div>

<script>
    const API = "/api"; const CLAVE = "2026";
    setInterval(() => { document.getElementById('relojVivo').innerText = new Date().toLocaleString(); }, 1000);
    function formatI(i) { let v = i.value.replace(/\D/g, ""); i.value = v ? new Intl.NumberFormat('de-DE').format(v) : ""; }
    function limpio(v) { return parseFloat(v.replace(/\./g, "")) || 0; }
    function fM(v) { return new Intl.NumberFormat('de-DE').format(v); }

    function validarAcceso() { if(document.getElementById('passAcceso').value===CLAVE){document.getElementById('bloqueo').classList.add('oculto');document.getElementById('contenidoWeb').classList.remove('oculto');refrescar();} }
    function toggle(id) { document.getElementById(id).classList.toggle('oculto'); }

    async function refrescar() {
        const r1 = await fetch(`${API}/receptores`); const recs = await r1.json();
        document.getElementById('listaReceptores').innerHTML = recs.map(r => `<div class="flex-row"><span onclick="histR('${r.nombre}')" style="color:blue;cursor:pointer;">${r.nombre}</span><span>Falta: $${fM(r.saldoRestante)}</span><button onclick="borrarR('${r._id}')">‚ùå</button></div>`).join('');
        document.getElementById('destinoProv').innerHTML = recs.map(r => `<option value="${r.nombre}">${r.nombre}</option>`).join('');
        const r2 = await fetch(`${API}/caja-hoy`); const caja = await r2.json();
        document.getElementById('cajaEfe').innerText = `$${fM(caja.totales.EFECTIVO)}`;
        document.getElementById('cajaTra').innerText = `$${fM(caja.totales.TRANSFERENCIA)}`;
        document.getElementById('cajaTar').innerText = `$${fM(caja.totales.TARJETA)}`;
        document.getElementById('listaDeudores').innerHTML = caja.deudores.map(d => `<div class="flex-row" onclick="irA('${d.nombre}')"><span>${d.nombre}</span><b>$${fM(d.deuda)}</b></div>`).join('');
    }

    async function autoCompletar() {
        const v = document.getElementById('inputBusqueda').value; if(v.length<2) return;
        const res = await fetch(`${API}/sugerencias/${v}`); const data = await res.json();
        document.getElementById('sugerencias').innerHTML = data.map(c => `<div class="sug-item" onclick="irA('${c.nombre}')">${c.nombre}</div>`).join('');
        document.getElementById('sugerencias').style.display='block';
    }

    async function buscarOCrear() {
        const v = document.getElementById('inputBusqueda').value.toUpperCase(); if(!v) return;
        const res = await fetch(`${API}/clientes/${v}`); const c = await res.json();
        abrir(c);
    }

    function abrir(c) {
        document.getElementById('nombreDisplay').innerText = c.nombre;
        document.getElementById('deudaDisplay').innerText = fM(c.deuda);
        document.getElementById('telDisplay').value = c.telefono || "";
        document.getElementById('ficha').classList.remove('oculto');
        document.getElementById('uiBusqueda').classList.add('oculto');
        document.getElementById('sugerencias').style.display='none';
    }

    async function guardarOp() {
        const body = { cliente: document.getElementById('nombreDisplay').innerText, compra: limpio(document.getElementById('gasto').value), pago: limpio(document.getElementById('pago').value), metodo: document.getElementById('metodo').value, destino: document.getElementById('destinoProv').value };
        await fetch(`${API}/operaciones`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body) });
        cerrarFicha(); refrescar();
    }

    async function irA(n) { const res = await fetch(`${API}/clientes/${n}`); const c = await res.json(); abrir(c); }
    function cerrarFicha() { document.getElementById('ficha').classList.add('oculto'); document.getElementById('uiBusqueda').classList.remove('oculto'); document.getElementById('inputBusqueda').value=""; }
    function verMetodo() { document.getElementById('divDestino').classList.toggle('oculto', document.getElementById('metodo').value !== 'TRANSFERENCIA'); }
    async function addRec() { await fetch(`${API}/receptores`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ nombre: document.getElementById('rn').value, monto: limpio(document.getElementById('rm').value) }) }); refrescar(); }
    async function borrarR(id) { const p = prompt("Clave:"); if(p==="moises1") { await fetch(`${API}/receptores/${id}`, { method:'DELETE' }); refrescar(); } }
</script>
</body>
</html>
