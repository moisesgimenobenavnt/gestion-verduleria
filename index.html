<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SaaS Verduler√≠a V4</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        :root {
            --bg: #eceff1; --negro: #212121; --rojo: #d50000; --verde: #00c853; --amarillo: #ffd600;
        }
        body { font-family: 'Roboto', sans-serif; background: var(--bg); margin: 0; padding-bottom: 50px; }
        .oculto { display: none !important; }
        
        /* LOGIN */
        #pantallaLogin { position: fixed; top:0; left:0; width:100%; height:100%; background:#fff; z-index:9999; display:flex; flex-direction:column; justify-content:center; align-items:center; }
        .input-login { width: 80%; max-width: 300px; padding: 15px; margin: 10px 0; border: 2px solid #333; text-align: center; text-transform: uppercase; font-size: 18px; }
        .btn-entrar { width: 85%; max-width: 340px; padding: 15px; background: #000; color: #fff; border: none; font-size: 18px; font-weight: bold; cursor: pointer; }

        /* ALERTA BACKUP */
        #modalBackup { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(200,0,0,0.98); z-index:10000; display:flex; flex-direction:column; justify-content:center; align-items:center; color:white; text-align:center; padding:20px; box-sizing:border-box; }
        
        /* HEADER PRINCIPAL */
        .bloque-principal { background: white; padding: 15px; border-bottom: 2px solid #ccc; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .buscador { width: 100%; padding: 15px; font-size: 20px; border: 2px solid #000; box-sizing: border-box; text-transform: uppercase; }
        .sugerencias { background: white; border: 1px solid #ccc; max-height: 200px; overflow-y: auto; position: absolute; width: 90%; z-index: 200; }
        .item-sug { padding: 15px; border-bottom: 1px solid #eee; font-size: 18px; cursor: pointer; }

        /* FICHA CLIENTE */
        .ficha { margin-top: 10px; border-left: 5px solid #333; padding-left: 10px; }
        .input-tel { border: none; border-bottom: 1px solid #999; width: 100%; padding: 5px; font-size: 16px; color: #555; margin-bottom: 5px; }
        .deuda-badge { padding: 5px 10px; color: white; font-weight: bold; border-radius: 4px; display: inline-block; font-size: 20px; }
        .bg-rojo { background: var(--rojo); }
        .bg-verde { background: var(--verde); }

        /* INPUTS VENTA */
        .grid-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .input-monto { padding: 15px; font-size: 22px; text-align: center; font-weight: bold; border: 2px solid #ccc; border-radius: 5px; width: 100%; box-sizing: border-box; }
        
        /* BOTONES PAGO */
        .grid-pagos { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; margin-top: 10px; }
        .btn-pago { padding: 15px; border: 1px solid #ccc; background: #fff; font-weight: bold; cursor: pointer; }
        .btn-pago.activo { background: #333; color: white; border-color: black; }

        /* COMPONENTE RECEPTOR (DOBLE CAJA + FLASH) */
        .box-receptor-outer { margin-top: 15px; padding: 8px; border-radius: 8px; text-align: center; transition: background 0.3s; display: none; }
        .box-receptor-inner { background: white; padding: 15px; border-radius: 5px; font-weight: bold; cursor: pointer; border: 1px solid rgba(0,0,0,0.1); }
        .flash-anim { animation: flash 0.3s 4; }
        @keyframes flash { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }

        /* ACORDEONES (DESPLEGABLES) */
        .acordeon { width: 100%; padding: 18px; text-align: left; background: #546e7a; color: white; border: none; margin-top: 5px; font-weight: bold; cursor: pointer; border-bottom: 1px solid #455a64; display: flex; justify-content: space-between; }
        .panel { display: none; background: white; padding: 10px; border: 1px solid #ccc; }
        .show { display: block; }

        /* LISTAS Y TABLAS */
        .fila { padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .fila-negra { background: black !important; color: white !important; text-decoration: line-through; }
        .fila-negra span { color: white; }

        .btn-guardar { width: 100%; padding: 20px; background: var(--verde); color: white; font-size: 20px; font-weight: bold; border: none; margin-top: 15px; cursor: pointer; }
        .btn-guardar:disabled { background: #ccc; }

    </style>
</head>
<body>

    <div id="pantallaLogin">
        <h2 style="margin-bottom:30px;">ACCESO SISTEMA</h2>
        <input type="text" id="u" class="input-login" placeholder="USUARIO">
        <input type="password" id="c" class="input-login" placeholder="CLAVE">
        <button class="btn-entrar" onclick="login()">ENTRAR</button>
        <p id="errorLogin" class="oculto" style="color:red; font-weight:bold;">DATOS INCORRECTOS</p>
    </div>

    <div id="modalBackup" class="oculto">
        <h1>‚ö†Ô∏è ALERTA OBLIGATORIA</h1>
        <p style="font-size:20px;">Regla del proveedor:<br>Debe descargar la copia de seguridad encriptada ahora mismo.</p>
        <button class="btn-entrar" style="background:white; color:red; margin-top:20px;" onclick="descargarBackup()">‚¨áÔ∏è DESCARGAR COPIA</button>
    </div>

    <div id="app" class="oculto">
        
        <div class="bloque-principal">
            <div style="display:flex; justify-content:space-between; font-size:12px; margin-bottom:5px;">
                <span id="lblUsuario">Usuario</span>
                <span style="color:red; cursor:pointer;" onclick="location.reload()">[Salir]</span>
            </div>

            <input type="text" id="buscador" class="buscador" placeholder="BUSCAR CLIENTE O TEL√âFONO..." onkeyup="buscar(this.value)">
            <div id="sugerencias" class="sugerencias oculto"></div>

            <div id="ficha" class="ficha oculto">
                <h2 id="cliNombre" style="margin:0;">NOMBRE</h2>
                <input type="text" id="cliTel" class="input-tel" placeholder="Sin Tel√©fono" onchange="actualizarTel()">
                
                <div style="margin:10px 0;">
                    <span id="badgeDeuda" class="deuda-badge">$ 0</span>
                    <button onclick="imprimirPDF()" style="float:right; background:#333; color:white; border:none; padding:5px;">üñ®Ô∏è PDF</button>
                </div>

                <div class="grid-inputs">
                    <div><small>VENTA</small><input type="tel" id="inVenta" class="input-monto" placeholder="$0" onkeyup="fmt(this); val()"></div>
                    <div><small>PAGO</small><input type="tel" id="inPago" class="input-monto" placeholder="$0" onkeyup="fmt(this); chkPago()"></div>
                </div>

                <div id="zonaPagos" class="oculto">
                    <div class="grid-pagos">
                        <button class="btn-pago" onclick="setMetodo('EFECTIVO', this)">EFECTIVO</button>
                        <button class="btn-pago" onclick="setMetodo('TARJETA', this)">TARJETA</button>
                        <button class="btn-pago" onclick="setMetodo('TRANSFERENCIA', this)">TRANSFER.</button>
                    </div>
                </div>

                <div id="boxReceptor" class="box-receptor-outer">
                    <div class="box-receptor-inner" 
                         onmousedown="verOjo(true)" onmouseup="verOjo(false)"
                         ontouchstart="verOjo(true)" ontouchend="verOjo(false)"
                         onclick="cambiarReceptor()">
                         <span id="txtReceptor">SELECCIONAR DESTINO</span>
                    </div>
                    <select id="selReceptor" class="oculto" onchange="seleccionarReceptor()"></select>
                </div>

                <button id="btnGuardar" class="btn-guardar" onclick="guardarVenta()" disabled>GUARDAR OPERACI√ìN</button>
            </div>
        </div>

        <button class="acordeon" onclick="toggle('panelCaja')">üí∞ CAJA Y MOVIMIENTOS <span>‚ñº</span></button>
        <div id="panelCaja" class="panel">
            <div id="filtrosDueno" class="oculto" style="background:#eee; padding:10px; margin-bottom:10px;">
                <label>Desde: <input type="date" id="fDesde"></label>
                <label>Hasta: <input type="date" id="fHasta"></label>
                <button onclick="cargarCaja()">üîé Filtrar</button>
                <div id="radiografia" style="margin-top:10px; font-weight:bold;"></div>
            </div>

            <div style="display:flex; gap:5px; margin-bottom:10px; padding:10px; background:#f5f5f5;">
                <input type="tel" id="montoCierre" class="input-monto" style="font-size:16px; padding:10px;" placeholder="EFECTIVO EN CAJA" onkeyup="fmt(this)">
                <button onclick="cerrarCaja()" style="background:black; color:white; border:none; padding:0 20px; font-weight:bold;">CERRAR CAJA</button>
            </div>

            <button onclick="cargarCaja()" style="width:100%; margin-bottom:10px;">üîÑ ACTUALIZAR LISTA</button>
            <div id="listaMovimientos"></div>
        </div>

        <button class="acordeon" onclick="toggle('panelGastos')">üí∏ GASTOS VARIOS <span>‚ñº</span></button>
        <div id="panelGastos" class="panel">
            <p style="font-size:12px; color:#666;">Buscador Inteligente (Crea si no existe):</p>
            <input type="text" id="buscaGasto" class="buscador" style="font-size:16px; padding:10px;" placeholder="EJ: BOLSAS..." onkeyup="buscarGasto(this.value)">
            <div id="sugGastos" class="sugerencias oculto" style="position:relative;"></div>
            
            <div id="formGasto" class="oculto" style="margin-top:10px; border-top:1px solid #ccc; padding-top:10px;">
                <strong id="lblGasto"></strong>
                <input type="tel" id="montoGasto" class="input-monto" placeholder="$ MONTO" onkeyup="fmt(this)">
                <button onclick="guardarGasto()" class="btn-guardar" style="margin-top:5px; background:var(--rojo);">REGISTRAR GASTO (RESTA CAJA)</button>
            </div>
        </div>

        <div id="soloDueno" class="oculto">
            <button class="acordeon">üë• LISTADO CLIENTES <span>‚ñº</span></button>
            <div class="panel">Solo visible para Due√±o...</div>
            
            <button class="acordeon">üìâ MAYORES DEUDORES <span>‚ñº</span></button>
            <div class="panel">Solo visible para Due√±o...</div>

            <button class="acordeon" onclick="cargarReceptoresCRUD()">üè¶ RECEPTORES (Config) <span>‚ñº</span></button>
            <div class="panel">
                <input id="newRecNombre" placeholder="NOMBRE" class="input-login" style="width:40%">
                <input id="newRecAlias" placeholder="ALIAS" class="input-login" style="width:40%">
                <button onclick="crearReceptor()">+</button>
                <div id="listaRecCRUD"></div>
            </div>
        </div>

    </div>

<script>
    // --- VARIABLES ---
    let ROL = '', USER = '', CLIENTE = null, METODO = '', RECEPTORES = [];
    
    // --- LOGIN ---
    async function login() {
        const u = document.getElementById('u').value;
        const c = document.getElementById('c').value;
        try {
            const res = await fetch('/api/login', {
                method:'POST', headers:{'Content-Type':'application/json'},
                body: JSON.stringify({usuario:u, clave:c})
            });
            const data = await res.json();
            if(data.ok) {
                ROL = data.rol; USER = data.nombre;
                iniciar();
            } else {
                document.getElementById('errorLogin').classList.remove('oculto');
            }
        } catch(e) { alert("Error conexi√≥n"); }
    }

    function iniciar() {
        document.getElementById('pantallaLogin').style.display = 'none';
        if(ROL === 'DUENO' || ROL === 'DEV') {
            document.getElementById('modalBackup').classList.remove('oculto');
        } else {
            entrarApp();
        }
    }

    function descargarBackup() {
        window.open('/api/backup/download');
        setTimeout(() => {
            document.getElementById('modalBackup').classList.add('oculto');
            entrarApp();
        }, 1500);
    }

    function entrarApp() {
        document.getElementById('app').classList.remove('oculto');
        document.getElementById('lblUsuario').innerText = USER;
        
        if(ROL === 'DUENO' || ROL === 'DEV') {
            document.getElementById('soloDueno').classList.remove('oculto');
            document.getElementById('filtrosDueno').classList.remove('oculto');
        }
        cargarReceptores(); // Cargar lista para memoria
    }

    // --- CLIENTES ---
    async function buscar(q) {
        if(q.length < 1) return document.getElementById('sugerencias').classList.add('oculto');
        const res = await fetch(`/api/sugerencias/${q}`);
        const data = await res.json();
        const div = document.getElementById('sugerencias');
        div.innerHTML = `<div class="item-sug" style="color:blue" onclick="crearCli('${q}')">‚ûï NUEVO: ${q}</div>`;
        data.forEach(c => {
            div.innerHTML += `<div class="item-sug" onclick='selCli(${JSON.stringify(c)})'>${c.nombre} (${c.telefono||'Sin Tel'})</div>`;
        });
        div.classList.remove('oculto');
    }

    async function crearCli(n) {
        const res = await fetch('/api/clientes/crear', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({nombre:n})});
        selCli(await res.json());
    }

    function selCli(c) {
        CLIENTE = c;
        document.getElementById('sugerencias').classList.add('oculto');
        document.getElementById('buscador').value = '';
        document.getElementById('ficha').classList.remove('oculto');
        
        document.getElementById('cliNombre').innerText = c.nombre;
        document.getElementById('cliTel').value = c.telefono; // Editable
        
        const bdg = document.getElementById('badgeDeuda');
        bdg.innerText = "$ " + format(c.deuda);
        bdg.className = c.deuda > 0 ? 'deuda-badge bg-rojo' : 'deuda-badge bg-verde';

        // Reset
        document.getElementById('inVenta').value = ''; document.getElementById('inPago').value = '';
        document.getElementById('zonaPagos').classList.add('oculto');
        document.getElementById('boxReceptor').style.display = 'none';
    }

    async function actualizarTel() {
        if(!CLIENTE) return;
        const t = document.getElementById('cliTel').value;
        await fetch('/api/clientes/actualizar-telefono', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body:JSON.stringify({id:CLIENTE._id, telefono:t})
        });
    }

    // --- OPERATIVA ---
    function chkPago() {
        const p = clean(document.getElementById('inPago').value);
        if(p > 0) document.getElementById('zonaPagos').classList.remove('oculto');
        else {
            document.getElementById('zonaPagos').classList.add('oculto');
            METODO = '';
        }
        val();
    }

    function setMetodo(m, btn) {
        METODO = m;
        document.querySelectorAll('.btn-pago').forEach(b => b.classList.remove('activo'));
        btn.classList.add('activo');
        
        const box = document.getElementById('boxReceptor');
        if(m === 'TRANSFERENCIA') {
            box.style.display = 'block';
            box.classList.add('flash-anim'); // FLASH
            setTimeout(()=>box.classList.remove('flash-anim'), 1200);
            
            // Memoria del √∫ltimo
            const last = localStorage.getItem('lastRec');
            if(last) {
                document.getElementById('selReceptor').value = last;
                seleccionarReceptor();
            }
        } else {
            box.style.display = 'none';
        }
        val();
    }

    async function cargarReceptores() {
        const res = await fetch('/api/receptores');
        RECEPTORES = await res.json();
        const s = document.getElementById('selReceptor');
        s.innerHTML = '<option value="">ELEGIR...</option>';
        RECEPTORES.forEach(r => {
            s.innerHTML += `<option value="${r._id}">${r.nombre} (${r.alias})</option>`;
        });
    }

    function cambiarReceptor() {
        // Truco para abrir el select oculto (en m√≥viles funciona mejor as√≠)
        // O simplemente mostrar el select
        document.getElementById('selReceptor').classList.remove('oculto');
        document.getElementById('selReceptor').focus();
    }

    function seleccionarReceptor() {
        const id = document.getElementById('selReceptor').value;
        const r = RECEPTORES.find(x => x._id === id);
        const boxOut = document.getElementById('boxReceptor');
        const txt = document.getElementById('txtReceptor');
        
        if(r) {
            localStorage.setItem('lastRec', id);
            txt.innerText = `${r.nombre} (${r.alias})`;
            document.getElementById('selReceptor').classList.add('oculto');
            
            // Sem√°foro
            const ratio = r.saldoPorPagar / r.topeMaximo;
            if(ratio > 0.9) boxOut.style.background = 'var(--rojo)';
            else if(ratio > 0.5) boxOut.style.background = 'var(--amarillo)';
            else boxOut.style.background = 'var(--verde)';
        }
        val();
    }

    function verOjo(ver) {
        const txt = document.getElementById('txtReceptor');
        if(ver) txt.innerText = "HOY: $ (Calculando...)"; // Aqu√≠ ir√≠a la llamada real si la tuvi√©ramos
        else {
            const id = document.getElementById('selReceptor').value;
            const r = RECEPTORES.find(x => x._id === id);
            if(r) txt.innerText = `${r.nombre} (${r.alias})`;
        }
    }

    function val() {
        const v = clean(document.getElementById('inVenta').value);
        const p = clean(document.getElementById('inPago').value);
        let ok = false;
        
        if(p > 0 && METODO) {
            if(METODO === 'TRANSFERENCIA') {
                if(document.getElementById('selReceptor').value) ok = true;
            } else ok = true;
        } else if (v > 0 && p === 0) ok = true; // Solo deuda
        
        document.getElementById('btnGuardar').disabled = !ok;
    }

    async function guardarVenta() {
        const v = clean(document.getElementById('inVenta').value);
        const p = clean(document.getElementById('inPago').value);
        const rId = document.getElementById('selReceptor').value;
        
        await fetch('/api/operaciones', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({
                clienteId: CLIENTE._id, compra:v, pago:p, metodo: p>0?METODO:'CUENTA', receptorId: rId
            })
        });
        
        alert("‚úÖ GUARDADO");
        document.getElementById('ficha').classList.add('oculto');
        document.getElementById('buscador').value = '';
    }

    // --- GASTOS (SMART) ---
    async function buscarGasto(q) {
        const div = document.getElementById('sugGastos');
        if(q.length < 2) return div.classList.add('oculto');
        
        const res = await fetch(`/api/gastos/sugerencias/${q}`);
        const data = await res.json();
        
        div.innerHTML = `<div class="item-sug" style="color:blue" onclick="selGasto('${q}')">‚ûï NUEVO: ${q}</div>`;
        data.forEach(g => {
            div.innerHTML += `<div class="item-sug" onclick="selGasto('${g}')">${g}</div>`;
        });
        div.classList.remove('oculto');
    }

    function selGasto(nombre) {
        document.getElementById('sugGastos').classList.add('oculto');
        document.getElementById('formGasto').classList.remove('oculto');
        document.getElementById('lblGasto').innerText = nombre;
    }

    async function guardarGasto() {
        const nombre = document.getElementById('lblGasto').innerText;
        const monto = clean(document.getElementById('montoGasto').value);
        if(monto <= 0) return alert("Ingrese monto");
        
        await fetch('/api/operaciones', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ esGasto: true, detalleGasto: nombre, pago: monto })
        });
        alert("GASTO REGISTRADO");
        document.getElementById('formGasto').classList.add('oculto');
        document.getElementById('buscaGasto').value = '';
    }

    // --- CAJA ---
    async function cargarCaja() {
        const fD = document.getElementById('fDesde').value;
        const fH = document.getElementById('fHasta').value;
        
        const res = await fetch('/api/caja', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ rol: ROL, fechaDesde: fD, fechaHasta: fH })
        });
        const data = await res.json();
        
        // Radiograf√≠a (Solo Due√±o)
        if(ROL !== 'EMPLEADO') {
            const t = data.totales;
            document.getElementById('radiografia').innerHTML = `
                Venta: $${format(t.totalVenta)} | Efvo: $${format(t.efectivo)}<br>
                Tarjeta: $${format(t.tarjeta)} | Transf: $${format(t.transf)}<br>
                Gastos: -$${format(t.gastos)}
            `;
        }

        const div = document.getElementById('listaMovimientos');
        div.innerHTML = '';
        data.movimientos.forEach(m => {
            if(m.esCierre) {
                div.innerHTML += `<div class="fila" style="background:#eee"><b>üîí CIERRE CAJA</b> <span>$ ${format(m.montoCierre)}</span></div>`;
                return;
            }
            
            let clase = m.esBorrado ? "fila fila-negra" : "fila";
            let btn = m.esBorrado ? "" : `<button onclick="borrar('${m._id}')" style="background:red;color:white;border:none;">X</button>`;
            
            div.innerHTML += `
                <div class="${clase}">
                    <div>
                        ${m.cliente} (${m.metodo})<br>
                        <b>$ ${format(m.pago || m.compra)}</b>
                    </div>
                    ${btn}
                </div>
            `;
        });
    }

    async function cerrarCaja() {
        const m = clean(document.getElementById('montoCierre').value);
        if(m <= 0 && !confirm("¬øCerrar en cero?")) return;
        
        await fetch('/api/cierre-caja', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ monto: m })
        });
        alert("‚úÖ CAJA CERRADA CORRECTAMENTE");
        document.getElementById('montoCierre').value = '';
        cargarCaja();
    }

    async function borrar(id) {
        if(!confirm("¬øANULAR? Se marcar√° en negro.")) return;
        await fetch('/api/operaciones/anular', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ idOperacion: id, usuario: USER })
        });
        cargarCaja();
    }

    // --- RECEPTORES CRUD (DUE√ëO) ---
    async function cargarReceptoresCRUD() {
        await cargarReceptores();
        const div = document.getElementById('listaRecCRUD');
        div.innerHTML = '';
        RECEPTORES.forEach(r => {
            div.innerHTML += `<div class="fila">${r.nombre} (${r.alias}) <span>Max: $${format(r.topeMaximo)}</span></div>`;
        });
    }

    async function crearReceptor() {
        const n = document.getElementById('newRecNombre').value;
        const a = document.getElementById('newRecAlias').value;
        await fetch('/api/receptores', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ nombre:n, alias:a })
        });
        cargarReceptoresCRUD();
    }

    // --- UTILIDADES ---
    function toggle(id) {
        document.querySelectorAll('.panel').forEach(p => { if(p.id !== id) p.classList.remove('show'); });
        document.getElementById(id).classList.toggle('show');
    }
    
    function imprimirPDF() {
        const doc = new jspdf.jsPDF();
        doc.text(`ESTADO DE CUENTA: ${CLIENTE.nombre}`, 20, 20);
        doc.text(`FECHA: ${new Date().toLocaleString()}`, 20, 30);
        doc.text(`DEUDA TOTAL: $ ${format(CLIENTE.deuda)}`, 20, 40);
        doc.text("-----------------------------------", 20, 50);
        doc.save(`Estado_${CLIENTE.nombre}.pdf`);
    }

    function fmt(i) { i.value = format(clean(i.value)); }
    function clean(v) { return parseInt(v.toString().replace(/\D/g,''))||0; }
    function format(v) { return new Intl.NumberFormat('es-AR').format(v); }

</script>
</body>
</html>
