<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Gesti√≥n Comercial Elite</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; margin: 0; padding: 20px; }
        .pantalla-inicio { min-height: 90vh; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .contenedor { width: 100%; max-width: 600px; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .seccion { border: 1px solid #e0e0e0; padding: 15px; border-radius: 10px; margin-bottom: 20px; background: #fff; }
        .deuda-box { font-size: 38px; color: #d32f2f; text-align: center; font-weight: bold; background: #ffebee; padding: 15px; border-radius: 10px; border: 2px solid #ffcdd2; margin: 10px 0; }
        .btn { padding: 15px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 15px; width: 100%; margin-top: 10px; }
        .btn-verde { background: #28a745; color: white; }
        .btn-azul { background: #007bff; color: white; }
        .btn-rojo { background: #dc3545; color: white; }
        .btn-gris { background: #6c757d; color: white; }
        .flex-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; }
        #sugerencias { position: absolute; background: white; border: 1px solid #ccc; width: 100%; max-width: 550px; z-index: 100; border-radius: 8px; }
        .sug-item { padding: 14px; cursor: pointer; border-bottom: 1px solid #eee; }
        .reloje { text-align: center; font-size: 14px; color: #666; margin-bottom: 10px; font-weight: bold; }
        .hist-item { font-size: 12px; padding: 8px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; }
        .negativo { color: #c53030; font-weight: bold; }
        .positivo { color: #276749; font-weight: bold; }
        #bloqueo { position: fixed; top:0; left:0; width:100%; height:100%; background:#f0f2f5; z-index:999; display:flex; flex-direction:column; justify-content:center; align-items:center; }
        .secretos { margin-top: 200px; opacity: 0.9; }
        @media print { .no-print { display: none; } }
    </style>
</head>
<body>

<div id="bloqueo" class="no-print">
    <h1>ü•¶ Acceso Privado</h1>
    <input type="password" id="passAcceso" placeholder="Contrase√±a" style="width: 250px; text-align: center; padding: 12px; border-radius: 8px; border: 1px solid #ccc;">
    <button class="btn btn-verde" style="width: 250px;" onclick="validarAcceso()">ENTRAR</button>
</div>

<div class="pantalla-inicio no-print" id="uiBusqueda" style="display:none;">
    <div class="contenedor">
        <h2>üîç Buscar Cliente / Tel</h2>
        <input type="text" id="inputBusqueda" placeholder="Ej: Ramon o 1123..." oninput="autoCompletar()" autocomplete="off" style="width:100%; padding:15px; font-size:18px; border-radius: 8px; border: 1px solid #ccc;">
        <div id="sugerencias"></div>
        <button class="btn btn-verde" onclick="buscarOCrear()">ABRIR FICHA</button>
    </div>
    <p style="color:#999; margin-top:40px;">‚¨áÔ∏è Desliza para reportes ‚¨áÔ∏è</p>
</div>

<div id="ficha" class="contenedor" style="display:none; margin: 20px auto;">
    <div class="reloje" id="relojVivo"></div>
    <h3 id="nombreDisplay" style="margin:0; text-align:center;"></h3>
    <div class="deuda-box">$ <span id="deudaDisplay">0</span></div>
    
    <div class="no-print">
        <label>üõí Compra ($):</label><input type="number" id="gasto" value="0">
        <label>üíµ Pago hoy ($):</label><input type="number" id="pago" value="0">
        <label>üí≥ M√©todo:</label>
        <select id="metodo" onchange="verMetodo()">
            <option value="EFECTIVO">Efectivo</option>
            <option value="TRANSFERENCIA">Transferencia</option>
            <option value="TARJETA">Tarjeta</option>
        </select>
        <div id="divDestino" style="display:none;">
            <label>üè¶ Enviar a:</label>
            <select id="destinoProv"></select>
        </div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <button class="btn btn-azul" onclick="guardarOp()">GUARDAR</button>
            <button class="btn btn-gris" onclick="verHistorial()">HISTORIAL</button>
        </div>
        <button class="btn btn-rojo" onclick="cerrarFicha()">CERRAR / NUEVO</button>
    </div>

    <div id="historialSeccion" style="display:none; margin-top:20px;">
        <hr>
        <div id="listaHistorial"></div>
        <button class="btn btn-gris no-print" onclick="window.print()">IMPRIMIR PDF</button>
    </div>
</div>

<div class="pantalla-inicio secretos no-print" id="uiReportes" style="display:none;">
    <div class="contenedor seccion">
        <h3>üìä Resumen de Hoy</h3>
        <button class="btn btn-gris" onclick="toggleD('detCaja')">Ver Caja y Deudores</button>
        <div id="detCaja" style="display:none;">
            <div class="flex-row"><span>Efectivo:</span> <b id="cajaEfe">$0</b></div>
            <div class="flex-row"><span>Transferencia:</span> <b id="cajaTra">$0</b></div>
            <div class="flex-row"><span>Tarjetas:</span> <b id="cajaTar">$0</b></div>
            <hr>
            <h4>Gente con deuda acumulada:</h4>
            <div id="listaDeudores"></div>
        </div>
    </div>

    <div class="contenedor seccion">
        <h3>üè¶ Receptores</h3>
        <div id="listaReceptores"></div>
        <hr>
        <input type="text" id="r_nom" placeholder="Nombre">
        <input type="number" id="r_mon" placeholder="Monto Total">
        <button class="btn btn-azul" onclick="addReceptor()">A√ëADIR / ACTUALIZAR</button>
    </div>
    <button class="btn btn-rojo" onclick="cerrarSesion()">CERRAR SESI√ìN</button>
</div>

<script>
    const API = "/api";
    const CLAVE = "2026";
    const fM = (n) => new Intl.NumberFormat('de-DE').format(n); // Funci√≥n para puntos de mil

    setInterval(() => { document.getElementById('relojVivo').innerText = new Date().toLocaleString(); }, 1000);

    window.onload = () => { if(localStorage.getItem('verduOK')==='si') mostrar(); };
    function validarAcceso() { if(document.getElementById('passAcceso').value===CLAVE) { localStorage.setItem('verduOK','si'); mostrar(); } else alert("Error"); }
    function mostrar() { document.getElementById('bloqueo').style.display='none'; document.getElementById('uiBusqueda').style.display='flex'; document.getElementById('uiReportes').style.display='flex'; refrescar(); }
    function cerrarSesion() { localStorage.removeItem('verduOK'); location.reload(); }
    function toggleD(id) { const e=document.getElementById(id); e.style.display=e.style.display==='none'?'block':'none'; }

    async function refrescar() {
        const r1 = await fetch(`${API}/receptores`);
        const recs = await r1.json();
        document.getElementById('listaReceptores').innerHTML = recs.map(r => `
            <div class="flex-row">
                <span style="color:blue; cursor:pointer;" onclick="histReceptor('${r.nombre}')"><b>${r.nombre}</b></span>
                <span>Falta: <b class="negativo">$${fM(r.saldoRestante)}</b> / Total: $${fM(r.montoObjetivo)}</span>
                <button onclick="borrarR('${r._id}')" style="background:none; border:none;">‚ùå</button>
            </div>`).join('');
        document.getElementById('destinoProv').innerHTML = recs.map(r => `<option value="${r.nombre}">${r.nombre}</option>`).join('');

        const r2 = await fetch(`${API}/caja-hoy`);
        const caja = await r2.json();
        document.getElementById('cajaEfe').innerText = `$${fM(caja.totales.EFECTIVO)}`;
        document.getElementById('cajaTra').innerText = `$${fM(caja.totales.TRANSFERENCIA)}`;
        document.getElementById('cajaTar').innerText = `$${fM(caja.totales.TARJETA)}`;
        document.getElementById('listaDeudores').innerHTML = caja.deudores.map(d => `<div class="flex-row"><span>${d.nombre}</span><b>$${fM(d.deuda)}</b></div>`).join('');
    }

    async function autoCompletar() {
        const v = document.getElementById('inputBusqueda').value;
        if(v.length < 2) return;
        const res = await fetch(`${API}/sugerencias/${v}`);
        const data = await res.json();
        document.getElementById('sugerencias').innerHTML = data.map(c => `<div class="sug-item" onclick="cargar('${c.nombre}','${c.deuda}')">${c.nombre} ($${fM(c.deuda)})</div>`).join('');
        document.getElementById('sugerencias').style.display = 'block';
    }

    async function buscarOCrear() {
        const v = document.getElementById('inputBusqueda').value.toUpperCase();
        if(!v) return;
        const res = await fetch(`${API}/clientes/${v}`);
        const c = await res.json();
        cargar(c.nombre, c.deuda);
    }

    function cargar(nom, deu) {
        document.getElementById('nombreDisplay').innerText = nom;
        document.getElementById('deudaDisplay').innerText = fM(deu);
        document.getElementById('gasto').value = 0;
        document.getElementById('pago').value = 0;
        document.getElementById('ficha').style.display = 'block';
        document.getElementById('uiBusqueda').style.display = 'none';
        document.getElementById('sugerencias').style.display = 'none';
        document.getElementById('historialSeccion').style.display = 'none';
    }

    function cerrarFicha() {
        document.getElementById('ficha').style.display = 'none';
        document.getElementById('uiBusqueda').style.display = 'flex';
        document.getElementById('inputBusqueda').value = '';
    }

    async function guardarOp() {
        const op = { cliente: document.getElementById('nombreDisplay').innerText, compra: parseFloat(document.getElementById('gasto').value), pago: parseFloat(document.getElementById('pago').value), metodo: document.getElementById('metodo').value, destino: document.getElementById('destinoProv').value };
        await fetch(`${API}/operaciones`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(op) });
        alert("Guardado");
        cerrarFicha();
        refrescar();
    }

    async function verHistorial() {
        const res = await fetch(`${API}/historial/${document.getElementById('nombreDisplay').innerText}`);
        const data = await res.json();
        document.getElementById('listaHistorial').innerHTML = data.map(h => `
            <div class="hist-item">
                <span><b>${new Date(h.fecha).toLocaleString()}</b></span>
                <span class="negativo">C: $${fM(h.compra)}</span>
                <span class="positivo">P: $${fM(h.pago)}</span>
            </div>`).join('');
        document.getElementById('historialSeccion').style.display = 'block';
    }

    async function histReceptor(nom) {
        const res = await fetch(`${API}/historial-receptor/${nom}`);
        const data = await res.json();
        alert("Env√≠os a " + nom + ":\n" + data.map(h => `${new Date(h.fecha).toLocaleDateString()} - $${fM(h.pago)} (de ${h.cliente})`).join('\n'));
    }

    async function addReceptor() {
        const p = prompt("Clave:"); if(p!==CLAVE) return;
        await fetch(`${API}/receptores`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ nombre: document.getElementById('r_nom').value, monto: document.getElementById('r_mon').value }) });
        document.getElementById('r_nom').value=''; document.getElementById('r_mon').value='';
        refrescar();
    }

    async function borrarR(id) { const p = prompt("Clave:"); if(p!==CLAVE) return; await fetch(`${API}/receptores/${id}`, { method: 'DELETE' }); refrescar(); }
    function verMetodo() { document.getElementById('divDestino').style.display = document.getElementById('metodo').value === 'TRANSFERENCIA' ? 'block' : 'none'; }
</script>
</body>
</html>
