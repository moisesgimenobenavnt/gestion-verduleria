<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gesti√≥n Comercial - SaaS</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-body: #eceff1;
            --bg-header: #263238;
            --color-rojo-neon: #ff1744;
            --color-verde-neon: #00e676;
            --color-alerta: #d50000;
            --negro-fila: #222;
        }
        body { font-family: 'Roboto', sans-serif; background: var(--bg-body); margin: 0; padding: 0; padding-bottom: 60px; -webkit-tap-highlight-color: transparent; }
        
        /* UTILIDADES */
        .oculto { display: none !important; }
        .full-width { width: 100%; box-sizing: border-box; }
        .texto-rojo { color: var(--color-alerta); font-weight: bold; }
        .texto-verde { color: var(--color-verde-neon); font-weight: bold; text-shadow: 0 0 2px #000; }
        
        /* FOOTER DE MARCA (Mois√©s Gimeno) */
        .footer-marca {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: #111; color: #555; text-align: center;
            padding: 5px; font-size: 10px; z-index: 99999;
            border-top: 1px solid #333;
        }
        .footer-marca span { color: #888; }

        /* ANIMACI√ìN FLASH */
        @keyframes flash-fosforito {
            0% { background-color: #fff; }
            50% { background-color: #ffff00; box-shadow: 0 0 20px #ffff00; }
            100% { background-color: #fff; }
        }
        .animacion-flash { animation: flash-fosforito 0.2s ease-in-out 5; }

        /* LOGIN SAAS */
        #pantallaLogin {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999;
            background: linear-gradient(135deg, #000 0%, #333 100%);
            display: flex; justify-content: center; align-items: center; flex-direction: column;
        }
        .login-card { background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 350px; text-align: center; }
        .input-login { width: 100%; padding: 15px; margin: 10px 0; border: 2px solid #ccc; border-radius: 8px; font-size: 18px; text-align: center; box-sizing: border-box; }
        .btn-login { width: 100%; padding: 15px; background: #000; color: #fff; border: none; border-radius: 8px; font-size: 18px; cursor: pointer; }

        /* HEADER */
        #headerCliente { background: #fff; height: 60px; display: flex; align-items: center; justify-content: center; position: relative; border-bottom: 2px solid #000; }
        .btn-cerrar-sesion { position: absolute; right: 10px; top: 15px; background: #333; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; }

        /* RELOJES */
        .barra-relojes {
            background: var(--bg-header); padding: 10px; display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0; z-index: 100; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .reloj-box {
            background: var(--color-rojo-neon); color: #fff; padding: 5px 12px; border-radius: 6px;
            font-family: 'Orbitron', sans-serif; text-align: center; border: 2px solid #fff; margin-left: 5px;
        }
        .reloj-dato { font-size: 20px; font-weight: 900; }

        /* ZONA TRABAJO */
        .zona-trabajo { max-width: 600px; margin: 0 auto; padding: 10px; padding-bottom: 80px; }

        /* BUSCADOR */
        .buscador-wrap { position: relative; margin-top: 15px; }
        .input-gigante {
            width: 100%; padding: 15px; font-size: 20px; border: 2px solid #333; border-radius: 10px;
            text-transform: uppercase; box-sizing: border-box;
        }
        .sugerencias-lista {
            position: absolute; top: 100%; left: 0; width: 100%; background: white; border: 1px solid #ccc;
            z-index: 50; max-height: 250px; overflow-y: auto; box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        .item-sugerencia { padding: 15px; border-bottom: 1px solid #eee; font-size: 18px; cursor: pointer; }
        .item-sugerencia:hover { background: #f0f0f0; }

        /* FICHA CLIENTE */
        .ficha-cliente {
            background: #fff; padding: 15px; border-radius: 10px; margin-top: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); border-left: 5px solid var(--bg-header);
        }
        .deuda-box {
            background: var(--color-rojo-neon); color: white; padding: 10px; border-radius: 8px;
            text-align: center; font-size: 24px; font-weight: 900; width: 100%; box-sizing: border-box;
        }
        .deuda-ok { background: var(--color-verde-neon); color: #000; }

        /* INPUTS MONTO */
        .input-monto {
            width: 100%; padding: 15px; font-size: 28px; font-weight: bold; text-align: center;
            border: 2px solid #aaa; border-radius: 10px; margin-top: 10px; box-sizing: border-box;
        }
        
        /* GRID PAGOS */
        .grid-pagos { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; margin-top: 15px; }
        .btn-metodo {
            padding: 15px; border: 2px solid #ccc; background: #fff; border-radius: 8px;
            font-weight: bold; cursor: pointer; font-size: 12px;
        }
        .btn-metodo.activo { background: #263238; color: #fff; border-color: #000; }
        
        .panel-transferencia {
            background: #e3f2fd; padding: 15px; border: 2px solid #2196f3; border-radius: 10px;
            margin-top: 10px; text-align: center;
        }
        .info-receptor { font-size: 12px; margin-top: 5px; display: block; color: #666; }

        /* ACORDEONES */
        .acordeon-btn {
            width: 100%; padding: 15px; background: #37474f; color: white; text-align: left;
            border: none; border-bottom: 1px solid #555; font-size: 16px; font-weight: bold; cursor: pointer;
            margin-top: 10px; display: flex; justify-content: space-between;
        }
        .acordeon-panel {
            background: #fff; padding: 10px; display: none; border: 1px solid #ccc; border-top: none;
        }

        /* BOTONES GRANDES */
        .btn-accion {
            width: 100%; padding: 20px; font-size: 20px; font-weight: bold; border: none; border-radius: 10px;
            cursor: pointer; margin-top: 20px; text-transform: uppercase; box-shadow: 0 4px 0 rgba(0,0,0,0.2);
        }
        .btn-guardar { background: #00e676; color: #000; }
        .btn-guardar:disabled { background: #ccc; cursor: not-allowed; color: #666; }
        
        /* FILAS DATOS */
        .fila-normal {
            background: #fff; padding: 10px; margin-bottom: 5px; border-bottom: 1px solid #eee;
            display: flex; justify-content: space-between; align-items: center;
        }

    </style>
</head>
<body>

    <div id="pantallaLogin">
        <div class="login-card">
            <h2 style="margin-top:0;">üîê ACCESO SEGURO</h2>
            <div style="font-size:12px; color:#666; margin-bottom:10px;">Identif√≠cate para continuar</div>
            <input type="text" id="loginId" class="input-login" placeholder="USUARIO" onkeyup="this.value=this.value.toUpperCase()">
            <input type="password" id="loginPass" class="input-login" placeholder="CLAVE">
            <button class="btn-login" onclick="iniciarSesion()">ENTRAR AL SISTEMA</button>
            <p id="msgError" style="color:red; display:none; margin-top:10px;">‚õî Credenciales Incorrectas</p>
        </div>
        <div style="color:white; margin-top:20px; font-size:10px;">Software Ver. 2.0</div>
    </div>

    <div id="sistemaApp" class="oculto">
        
        <div id="headerCliente">
            <h1 style="margin:0; font-size:20px;">SISTEMA GESTI√ìN</h1>
            <button class="btn-cerrar-sesion" onclick="location.reload()">SALIR</button>
        </div>

        <div class="barra-relojes">
            <div style="color:white; font-weight:bold; font-size:14px;" id="usuarioDisplay">...</div>
            <div style="display:flex;">
                <div class="reloj-box">
                    <div class="reloj-dato" id="relojHora">--:--</div>
                </div>
                <div class="reloj-box">
                    <div class="reloj-dato" id="relojFecha">--/--</div>
                </div>
            </div>
        </div>

        <div class="zona-trabajo">

            <div class="buscador-wrap">
                <input type="text" id="inputBuscar" class="input-gigante" placeholder="BUSCAR CLIENTE..." onkeyup="buscarClientes(this.value)">
                <div id="sugerencias" class="sugerencias-lista oculto"></div>
            </div>

            <div id="fichaCliente" class="ficha-cliente oculto">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h2 style="margin:0;" id="cliNombre">NOMBRE</h2>
                    <button onclick="editarTelefono()" style="background:#eee; border:none; border-radius:5px; cursor:pointer;">‚úèÔ∏è</button>
                </div>
                <div style="color:#666; margin-bottom:5px;" id="cliTel">Tel: ---</div>
                
                <div id="boxDeuda" class="deuda-box">$ 0</div>
                
                <div style="margin-top:20px; border-top:2px dashed #ccc; padding-top:10px;">
                    <label style="font-weight:bold;">MONTO VENTA:</label>
                    <input type="tel" id="inputMontoVenta" class="input-monto" placeholder="$ 0" onkeyup="formatoMoneda(this); validarGuardado()">
                    
                    <label style="font-weight:bold; display:block; margin-top:10px;">PAGO (Lo que entrega):</label>
                    <input type="tel" id="inputMontoPago" class="input-monto" placeholder="$ 0" onkeyup="formatoMoneda(this); checkPagoObligatorio()">
                </div>

                <div id="zonaMetodos" class="oculto">
                    <div class="grid-pagos">
                        <button class="btn-metodo" onclick="setMetodo('EFECTIVO', this)">üíµ CAJA (Efvo)</button>
                        <button class="btn-metodo" onclick="setMetodo('TARJETA', this)">üí≥ TARJETA</button>
                        <button class="btn-metodo" onclick="setMetodo('TRANSFERENCIA', this)">üè¶ PROVEEDOR</button>
                    </div>

                    <div id="panelTransf" class="panel-transferencia oculto">
                        <strong>DESTINO DEL PAGO (PROVEEDOR):</strong><br>
                        <small>Elige qu√© deuda externa est√°s pagando con esta transferencia:</small>
                        <select id="selectReceptor" style="width:100%; padding:10px; margin-top:5px; font-size:16px;" onchange="validarGuardado()">
                        </select>
                        <span id="infoReceptorSaldo" class="info-receptor"></span>
                    </div>
                </div>

                <button id="btnGuardar" class="btn-accion btn-guardar" onclick="guardarOperacion()" disabled>GUARDAR OPERACI√ìN</button>
            </div>

            <button class="acordeon-btn" onclick="toggleBloque('bloqueCaja')">üí∞ CAJA Y MOVIMIENTOS <span>‚ñº</span></button>
            <div id="bloqueCaja" class="acordeon-panel">
                <button onclick="cargarCaja()" style="width:100%; padding:10px; margin-bottom:10px;">üîÑ ACTUALIZAR CAJA</button>
                
                <div id="vistaCajaDueno">
                    <h3 style="border-bottom:2px solid #000;">RADIOGRAF√çA DEL D√çA</h3>
                    <div class="fila-normal"><strong>VENTA TOTAL (Facturado):</strong> <span id="lblTotalVenta">$ 0</span></div>
                    <hr>
                    <div class="fila-normal" style="background:#e8f5e9;"><strong>EFECTIVO (En Caj√≥n):</strong> <span id="lblTotalEfvo" style="font-size:18px; font-weight:bold;">$ 0</span></div>
                    <div class="fila-normal">Tarjeta: <span id="lblTotalTarjeta">$ 0</span></div>
                    <div class="fila-normal">Transferencia (A Proveedores): <span id="lblTotalTransf">$ 0</span></div>
                    <div class="fila-normal" style="background:#ffebee;"><strong>GASTOS SALIDA:</strong> <span id="lblTotalGastos" style="color:red;">$ 0</span></div>
                </div>
                
                <h4 style="margin-top:20px;">√öltimos Movimientos:</h4>
                <div id="listaMovimientos" style="font-size:12px;"></div>
            </div>

            <button class="acordeon-btn" onclick="toggleBloque('bloqueGastos')">üìâ REGISTRAR GASTO <span>‚ñº</span></button>
            <div id="bloqueGastos" class="acordeon-panel">
                <label>Concepto (Ej: Pan, Luz, Limpieza):</label>
                <input type="text" id="inputGastoConcepto" class="input-gigante" placeholder="DETALLE...">
                <input type="tel" id="inputMontoGasto" class="input-monto" placeholder="$ 0" onkeyup="formatoMoneda(this)">
                
                <div style="display:flex; gap:10px; margin-top:15px;">
                    <button class="btn-accion" style="background:#ccc; font-size:16px;" onclick="guardarGasto('EFECTIVO')">PAGAR DE CAJA</button>
                </div>
            </div>

            <button class="acordeon-btn" style="background:#d32f2f;" onclick="toggleBloque('bloqueDeudores')">üíÄ MAYORES DEUDORES <span>‚ñº</span></button>
            <div id="bloqueDeudores" class="acordeon-panel">
                <button onclick="cargarDeudores()" style="width:100%;">üîÑ ACTUALIZAR LISTA</button>
                <div id="listaDeudores"></div>
            </div>

            <button class="acordeon-btn" id="btnReceptores" style="background:#fbc02d; color:black;" onclick="toggleBloque('bloqueReceptores')">üè¶ GESTI√ìN DEUDAS EXTERNAS <span>‚ñº</span></button>
            <div id="bloqueReceptores" class="acordeon-panel">
                <h3>Agregar Deuda con Tercero</h3>
                <input type="text" id="recNombre" placeholder="Nombre Proveedor" class="input-login">
                <input type="text" id="recAlias" placeholder="Alias/CBU" class="input-login">
                <input type="tel" id="recMonto" placeholder="Monto Deuda Total ($)" class="input-login" onkeyup="formatoMoneda(this)">
                <button onclick="nuevoReceptor()" class="btn-accion" style="font-size:14px; padding:10px;">‚ûï GUARDAR DEUDA</button>
                
                <hr>
                <h4>Estado de Cuentas:</h4>
                <div id="listaReceptoresAdmin"></div>
            </div>

        </div>
    </div>

    <div class="footer-marca">
        üíª Software Desarrollado por <strong>Mois√©s Gimeno</strong> | üìû Soporte T√©cnico: <span>+54 9 XX XXXX XXXX</span>
    </div>

<script>
    // ==========================================
    // üß† L√ìGICA CONECTADA AL SERVIDOR
    // ==========================================

    let USUARIO_ACTUAL = null;
    let CLIENTE_SEL = null;
    let METODO_PAGO = "";
    let RECEPTORES_CACHE = [];

    // --- 1. LOGIN ---
    async function iniciarSesion() {
        const id = document.getElementById('loginId').value;
        const pass = document.getElementById('loginPass').value;

        try {
            const res = await fetch('/api/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id, pass })
            });
            const data = await res.json();

            if (data.ok) {
                USUARIO_ACTUAL = data.usuario;
                entrarSistema();
            } else {
                document.getElementById('msgError').style.display = 'block';
            }
        } catch (e) {
            alert("‚ùå Error de conexi√≥n con el servidor");
        }
    }

    function entrarSistema() {
        document.getElementById('pantallaLogin').style.display = 'none';
        document.getElementById('sistemaApp').classList.remove('oculto');
        document.getElementById('usuarioDisplay').innerText = "üë§ " + USUARIO_ACTUAL.nombre;
        
        // Permisos
        if(USUARIO_ACTUAL.tipo === 'EMPLEADO') {
            document.getElementById('btnReceptores').style.display = 'none'; // Ocultar gesti√≥n receptores
        }
        
        actualizarReloj();
        cargarReceptores(); // Precargar lista para el select
    }

    // --- 2. CLIENTES ---
    async function buscarClientes(query) {
        if (query.length < 1) {
            document.getElementById('sugerencias').classList.add('oculto');
            return;
        }
        
        const res = await fetch(`/api/sugerencias/${query}`);
        const clientes = await res.json();
        const div = document.getElementById('sugerencias');
        div.innerHTML = '';

        // Bot√≥n Nuevo
        let html = `<div class="item-sugerencia" style="color:blue" onclick="crearCliente('${query}')">‚ûï NUEVO: "${query}"</div>`;
        
        clientes.forEach(c => {
            html += `<div class="item-sugerencia" onclick='seleccionarCliente(${JSON.stringify(c)})'>${c.nombre} (${c.telefono})</div>`;
        });

        div.innerHTML = html;
        div.classList.remove('oculto');
    }

    async function crearCliente(nombre) {
        const res = await fetch('/api/clientes/crear', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ nombre })
        });
        const nuevo = await res.json();
        seleccionarCliente(nuevo);
    }

    function seleccionarCliente(cliente) {
        CLIENTE_SEL = cliente;
        document.getElementById('sugerencias').classList.add('oculto');
        document.getElementById('inputBuscar').value = '';
        
        document.getElementById('fichaCliente').classList.remove('oculto');
        document.getElementById('cliNombre').innerText = cliente.nombre;
        document.getElementById('cliTel').innerText = cliente.telefono || "Sin Tel√©fono";
        
        const box = document.getElementById('boxDeuda');
        box.innerText = "$ " + numberFormat(cliente.deuda);
        box.className = cliente.deuda > 0 ? 'deuda-box' : 'deuda-box deuda-ok';

        // Reset
        document.getElementById('inputMontoVenta').value = '';
        document.getElementById('inputMontoPago').value = '';
        document.getElementById('zonaMetodos').classList.add('oculto');
        document.getElementById('btnGuardar').disabled = true;
    }

    async function editarTelefono() {
        const nuevo = prompt("Nuevo Tel√©fono:", CLIENTE_SEL.telefono);
        if (nuevo !== null) {
            await fetch('/api/clientes/update-tel', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ id: CLIENTE_SEL._id, telefono: nuevo })
            });
            CLIENTE_SEL.telefono = nuevo;
            document.getElementById('cliTel').innerText = nuevo;
        }
    }

    // --- 3. OPERACIONES ---
    function checkPagoObligatorio() {
        const pago = cleanNumber(document.getElementById('inputMontoPago').value);
        if (pago > 0) {
            document.getElementById('zonaMetodos').classList.remove('oculto');
            document.getElementById('btnGuardar').disabled = true; // Esperar m√©todo
        } else {
            document.getElementById('zonaMetodos').classList.add('oculto');
            validarGuardado();
        }
    }

    function setMetodo(metodo, btn) {
        METODO_PAGO = metodo;
        document.querySelectorAll('.btn-metodo').forEach(b => b.classList.remove('activo'));
        btn.classList.add('activo');

        const panel = document.getElementById('panelTransf');
        if (metodo === 'TRANSFERENCIA') {
            panel.classList.remove('oculto');
            panel.classList.add('animacion-flash');
            setTimeout(() => panel.classList.remove('animacion-flash'), 1000);
        } else {
            panel.classList.add('oculto');
        }
        validarGuardado();
    }

    function validarGuardado() {
        // Esta es la funci√≥n que faltaba antes
        const venta = cleanNumber(document.getElementById('inputMontoVenta').value);
        const pago = cleanNumber(document.getElementById('inputMontoPago').value);
        const btn = document.getElementById('btnGuardar');

        // L√≥gica b√°sica:
        // 1. Debe haber monto de venta O monto de pago (para pagar deuda vieja)
        if (venta <= 0 && pago <= 0) { btn.disabled = true; return; }

        // 2. Si hay pago, debe haber m√©todo
        if (pago > 0) {
            if (!METODO_PAGO) { btn.disabled = true; return; }
            if (METODO_PAGO === 'TRANSFERENCIA') {
                // Si es transf, debe haber receptor seleccionado
                const recId = document.getElementById('selectReceptor').value;
                if (!recId) { btn.disabled = true; return; }
            }
        }

        btn.disabled = false;
    }

    async function guardarOperacion() {
        const venta = cleanNumber(document.getElementById('inputMontoVenta').value);
        const pago = cleanNumber(document.getElementById('inputMontoPago').value);
        const receptorId = (METODO_PAGO === 'TRANSFERENCIA') ? document.getElementById('selectReceptor').value : null;

        const data = {
            clienteId: CLIENTE_SEL._id,
            compra: venta,
            pago: pago,
            metodo: pago > 0 ? METODO_PAGO : 'CUENTA_CORRIENTE',
            receptorId: receptorId
        };

        const res = await fetch('/api/operaciones', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });

        if (res.ok) {
            alert("‚úÖ GUARDADO");
            document.getElementById('fichaCliente').classList.add('oculto');
            document.getElementById('inputBuscar').value = '';
            // Recargar datos fondo
            cargarReceptores(); 
        } else {
            alert("Error al guardar");
        }
    }

    // --- 4. CAJA Y DEUDAS ---
    async function cargarCaja() {
        const res = await fetch('/api/caja-hoy');
        const data = await res.json();
        
        // Totales
        const t = data.totales;
        document.getElementById('lblTotalVenta').innerText = "$ " + numberFormat(t.ventaTotal);
        document.getElementById('lblTotalEfvo').innerText = "$ " + numberFormat(t.efectivoMano);
        document.getElementById('lblTotalTarjeta').innerText = "$ " + numberFormat(t.tarjeta);
        document.getElementById('lblTotalTransf').innerText = "$ " + numberFormat(t.transf);
        document.getElementById('lblTotalGastos').innerText = "$ " + numberFormat(t.gastos);

        // Lista
        let html = '';
        data.movimientos.slice(0, 10).forEach(m => {
            html += `<div class="fila-normal">
                <span>${m.cliente} (${m.metodo})</span>
                <b>$ ${numberFormat(m.pago || m.compra)}</b>
            </div>`;
        });
        document.getElementById('listaMovimientos').innerHTML = html;
    }

    async function guardarGasto(metodo) {
        const detalle = document.getElementById('inputGastoConcepto').value;
        const monto = cleanNumber(document.getElementById('inputMontoGasto').value);
        
        if(!detalle || monto <= 0) return alert("Faltan datos");

        const res = await fetch('/api/gastos', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ detalle, monto, metodo })
        });
        
        if(res.ok) {
            alert("üìâ Gasto registrado");
            document.getElementById('inputGastoConcepto').value = '';
            document.getElementById('inputMontoGasto').value = '';
            cargarCaja();
        }
    }

    async function cargarDeudores() {
        const res = await fetch('/api/deudores');
        const lista = await res.json();
        const div = document.getElementById('listaDeudores');
        div.innerHTML = '';
        
        lista.forEach(d => {
            div.innerHTML += `<div class="fila-normal" style="border-left:4px solid red;">
                <span>${d.nombre}</span>
                <b>$ ${numberFormat(d.deuda)}</b>
            </div>`;
        });
    }

    // --- 5. RECEPTORES (Gesti√≥n Deudas Externas) ---
    async function cargarReceptores() {
        const res = await fetch('/api/receptores');
        RECEPTORES_CACHE = await res.json();
        
        const sel = document.getElementById('selectReceptor');
        const listaAdmin = document.getElementById('listaReceptoresAdmin');
        sel.innerHTML = '<option value="">-- Seleccionar --</option>';
        listaAdmin.innerHTML = '';

        RECEPTORES_CACHE.forEach(r => {
            // Select (Solo mostrar si hay deuda por pagar)
            if (r.saldoPorPagar > 0) {
                sel.innerHTML += `<option value="${r._id}">${r.nombre} (Debemos: $${numberFormat(r.saldoPorPagar)})</option>`;
            }

            // Lista Admin
            listaAdmin.innerHTML += `
                <div class="fila-normal">
                    <div>
                        <strong>${r.nombre}</strong> <small>${r.alias}</small><br>
                        <span style="color:red">Falta Pagar: $${numberFormat(r.saldoPorPagar)}</span>
                        <br><small style="color:#666">Deuda Orig: $${numberFormat(r.deudaOriginal)}</small>
                    </div>
                    <button onclick="vaciarReceptor('${r._id}')" style="background:#222; color:#fff; border:none; border-radius:4px;">üÜó PAGADO</button>
                </div>
            `;
        });
    }

    async function nuevoReceptor() {
        const nombre = document.getElementById('recNombre').value;
        const alias = document.getElementById('recAlias').value;
        const monto = cleanNumber(document.getElementById('recMonto').value);

        if(!nombre || monto <= 0) return alert("Faltan datos");

        await fetch('/api/receptores', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ nombre, alias, montoDeuda: monto })
        });
        
        alert("Proveedor Guardado");
        document.getElementById('recNombre').value = '';
        document.getElementById('recMonto').value = '';
        cargarReceptores();
    }

    async function vaciarReceptor(id) {
        if(confirm("¬øMarcar toda la deuda con este proveedor como PAGADA manualmente?")) {
            await fetch('/api/receptores/vaciar', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ id })
            });
            cargarReceptores();
        }
    }


    // --- HELPERS ---
    function actualizarReloj() {
        const now = new Date();
        document.getElementById('relojHora').innerText = now.getHours().toString().padStart(2,'0') + ":" + now.getMinutes().toString().padStart(2,'0');
        document.getElementById('relojFecha').innerText = now.getDate().toString().padStart(2,'0') + "/" + (now.getMonth()+1).toString().padStart(2,'0');
        setTimeout(actualizarReloj, 1000);
    }
    function toggleBloque(id) {
        const panel = document.getElementById(id);
        panel.style.display = (panel.style.display === 'block') ? 'none' : 'block';
    }
    function formatoMoneda(input) {
        let val = input.value.replace(/\D/g, '');
        if(val === '') return;
        input.value = new Intl.NumberFormat('es-AR').format(val);
    }
    function cleanNumber(val) {
        return parseInt(val.replace(/\./g, '') || 0);
    }
    function numberFormat(val) {
        return new Intl.NumberFormat('es-AR').format(val);
    }

</script>
</body>
</html>
